Objective Tables created 
These have dates/year of 2021
Table Names = Count: Yes No
hap_ddr_raw.zz_obj_HS_20_HJ = 369,386: 6,699-Y 362,687-N
hap_ddr_raw.zz_obj_MSK_HJ = 369,386: 60,482-Y 308,904-N
hap_ddr_raw.zz_obj_MH_20_HJ = 369,386: 23,319-Y 346,067-N
hap_ddr_raw.zz_obj_MSK_CB_Cohort_Label_HJ = 1,338,163

2019 data 
hap_ddr_raw.zz_obj_CB_partcost19_HJ = 1,338,163
hap_ddr_raw.zz_part1_f19_HJ = 1338163
hap_ddr_raw.zz_part2_f19_HJ = 1338163 
hap_ddr_raw.zz_part3_f19_HJ = 1338163 


2020 data
hap_ddr_raw.zz_obj_CB_partcost20_HJ = 1338163 
hap_ddr_raw.zz_part1_f20_HJ = 1338163
hap_ddr_raw.zz_part2_f20_HJ = 1338163
hap_ddr_raw.zz_part3_f20_HJ = 1338163


2021 data
hap_ddr_raw.zz_obj_CB_partcost21_HJ = 1338163
hap_ddr_raw.zz_part1_f21_HJ = 1338163
hap_ddr_raw.zz_part2_f21_HJ = 1338163
hap_ddr_raw.zz_part3_f21_HJ = 1338163


Stiching costs & health flags
hap_ddr_raw.zz_eda_part1_final_costYr_Yr_0Yr_1_HJ = 1279122 (partcost19 + partcost20 + partcost21)


hap_ddr_raw.zz_eda_Yr_0_health_flags_HJ = 1279122 (part1_f20 + part2_f20 + part3_f20)
hap_ddr_raw.zz_eda_Yr_1_health_flags_HJ = 1279122 (part1_f19 + part2_f19 + part3_f19)
hap_ddr_raw.zz_eda_Yr_health_flags_HJ   = 1279122 (part1_f21 + part2_f21 + part3_f21)
hap_ddr_raw.zz_eda_Yr_Yr_0_Yr_1_health_flags_HJ = 1279122 (Yr_0_health_flags + Yr_1_health_flags + Yr_health_flags )

2021 Procedure category data
hap_ddr_raw.zz_eda_vist_p1_HJ - hap_ddr_raw.zz_eda_vist_p11_HJ
hap_ddr_raw.zz_eda_part4_proc_cat_final_HJ = 1338163 (hap_ddr_raw.zz_eda_vist_p1_HJ + ... + hap_ddr_raw.zz_eda_vist_p11_HJ)

hap_ddr_raw.zz_eda_part4_proc_cat_final_y1_HJ = 1338163
hap_ddr_raw.zz_eda_part4_proc_cat_final_y0_HJ = 1338163 

 

hap_ddr_raw.zz_eda_part4_visit_HJ = 3,083,572 
hap_ddr_raw.zz_eda_vist_p1_HJ - hap_ddr_raw.zz_eda_vist_p11_HJ
hap_ddr_raw.zz_eda_part4_proc_cat_final_HJ = 883,692 (hap_ddr_raw.zz_eda_vist_p1_HJ + ... + hap_ddr_raw.zz_eda_vist_p11_HJ)


2019 Procedure category data
hap_ddr_raw.zz_eda_part4_visit_y1_HJ = 2,032,133
hap_ddr_raw.zz_eda_vist_p1_y1_HJ - hap_ddr_raw.zz_eda_vist_p11_y1_HJ
						(hap_ddr_raw.zz_eda_vist_p1_y1_HJ - hap_ddr_raw.zz_eda_vist_p11_y1_HJ)


2020 Procedure category data
hap_ddr_raw.zz_eda_part4_visit_y0_HJ = 2,544,463
hap_ddr_raw.zz_eda_vist_p1_y0_HJ - hap_ddr_raw.zz_eda_vist_p11_y0_HJ
						  (hap_ddr_raw.zz_eda_vist_p1_y0_HJ - hap_ddr_raw.zz_eda_vist_p11_y0_HJ)




Final tables
hap_ddr_raw.zz_eda_modelling_spine_CKHBSurgery_MSK_HJ = 1338163 

Objective/Target queries
******************************************************************************************************

Total rows - 2850665
---------------------------------------------------------------

create table hap_ddr_raw.zz_obj_MSK_CB_Cohort_HJ AS ( 
SELECT c.person_internal_id
,c.partneremployerid
,c.person_key as patient_key
FROM edh_analytic_solutions_db.compass_claim_raw_person_identifiers c
JOIN edh_analytic_solutions_db.udp_person_idmapping idm
ON c.person_internal_id = CAST(idm.platforminternalid AS INT)
AND c.partneremployerid = CAST(idm.normalizedclientid AS INT)
JOIN edh_analytic_solutions_db.participant_integrated ppt
ON ppt.udp_global_id = idm.globalpersonidentifier
AND ppt.client_id = CAST(idm.normalizedclientid AS INT)
JOIN edh_analytic_solutions_db.participant ppt2
ON ppt2.person_internal_id = c.person_internal_id
AND ppt2.client_id = c.partneremployerid
WHERE ppt2.client_id NOT IN (1487,80939,80940,82132,1881,80576,81375,81459,5987,81558,81127,81557,1012,82207,1526,1700
,2491,81889,81020,81606,1007,82007,695,82012,81578,81973,1683,9813,1971,81892,82258,81907
,4269,81457,5434,80835,82212,81400,707,81800,81679,81680,81733,2496,3687,81369,16581)
AND (ucase(ppt2.emplstat_code) = 'ACTIVE' or (ucase(ppt2.emplstat_code) != 'ACTIVE' and ppt2.emplstat_effective_begin_date >= date_add(Current_TimeStamp(), Interval -365 Day)))
);


create table hap_ddr_raw.zz_obj_MSK_CB_Cohort_Label_HJ AS ( 
SELECT z.person_internal_id
,z.partneremployerid
,z.patient_key
,MAX(if(bt.chronic_or_acute='chronic' AND bt.spine='Y','Yes','No')) as MSK_CBNoSurgery_flag_Obj21
FROM hap_ddr_raw.zz_obj_MSK_CB_Cohort_HJ z
LEFT JOIN hap_ddr_raw.compass_claims_rollup_2021 a
ON z.patient_key = a.patient_key
AND z.partneremployerid = a.partneremployerid
LEFT JOIN edh_analytic_solutions_db.compass_claims_raw_diagnosis b
ON a.diagnosis_key = b.diagnosis_key
LEFT JOIN edh_analytic_solutions_db.compass_claim_raw_person_identifiers c
ON  a.patient_key = c.person_key
AND a.partneremployerid= c.partneremployerid
LEFT JOIN hap_ddr_raw.MSK_input_20220707 bt
ON b.diagnosis_code_description = bt.diagnosis_code
WHERE a.start_date_key >= 20210101
AND a.end_date_key <= 20211231
GROUP BY 1,2,3
);



###############################################################################################################
###############################################################################################################
**********************
****EDA FULL 2019*****  Total rows - 2850665
******************************************************************
****Costs & Flags *Preventive Codes**Comorbidity  Codes**Chronic  Codes*
*****************************************************************

create table hap_ddr_raw.zz_obj_CB_partcost19_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21  
,MAX(if(b.h1_rollup_description = 'Mental disorders','Yes','No')) as MH_flag_Yr_1
,MAX(if(bt.chronic_or_acute='chronic' AND bt.surgery_solution='Surgery Solution' AND (bt.knee='Y' OR bt.hip='Y' OR bt.spine='Y'),'Yes','No')) as MSK_CKHBSurgery_flag_Yr_1
,MAX(if(bt.chronic_or_acute='chronic' AND (bt.knee='Y' OR bt.hip='Y'),'Yes','No')) as MSK_CKHNoSurgery_flag_Yr_1
,MAX(if(bt.chronic_or_acute='chronic' AND bt.spine='Y','Yes','No')) as MSK_CBNoSurgery_flag_Yr_1
,if(SUM(amount_allowed) > 10000,'Yes','No') as HS_flag_Yr_1 
,SUM(a.amount_allowed) as tot_billed_amt_Yr_1 
,AVG(a.amount_allowed) as avg_billed_amt_Yr_1 
,STDDEV(a.amount_allowed) as std_billed_amt_Yr_1 
,MAX(a.amount_allowed) as max_billed_amt_Yr_1 
,SUM(a.amount_Plan) as  employer_paid_Yr_1 
,SUM(a.amount_Employee_Copay) as employee_paid1_Yr_1 
,SUM(a.amount_Employee_Coinsurance) as employee_paid2_Yr_1 
,SUM(a.amount_Employee_Deductible) as paid_thr_deduct_Yr_1 
FROM hap_ddr_raw.zz_obj_MSK_CB_Cohort_Label_HJ c
LEFT JOIN hap_ddr_raw.compass_claims_rollup_2019 a
ON a.patient_key = c.patient_key
AND a.partneremployerid = c.partneremployerid
LEFT JOIN edh_analytic_solutions_db.compass_claims_raw_diagnosis b
ON a.diagnosis_key = b.diagnosis_key
LEFT JOIN hap_ddr_raw.MSK_input_20220707 bt
ON b.diagnosis_code_description = bt.diagnosis_code
GROUP BY 1,2,3,4
)

############################################################################################Total rows - 664653
#######################################
create table hap_ddr_raw.zz_part1_f19_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21
,MAX(if(b.cpt_hcpcs_procedure_key in (4500,
6987,8610,8611,8612,8613,8615,8617,8618,8619,8622,8623,8624,
8625,8626,8628,8634,8635,8644,8645,8646,8647,8653,8655,8657,
8658,8659,8660,8662,8665,8666,8669,8670,8671,8673,8677,8678,
9570,9571,9572,9573,9574,9575,9576,9577,9578,9579,9580,9581,
9582,9583,11894,11895,11896,11915,11916,11925,11945,12050,14589,
14590,14639,14965,15105,948,7494,2616,11898,18077,691,3700,12444,
16925,17235,18444,19614,16928,16930,494,8663,12019,8651,8654,8614,
8595,8649,8650,8651,8652)
AND b.cpt_hcpcs_procedure_code in ('45378',
'77057','90632','90633','90634','90636','90645','90647','90648',
'90649','90655','90656','90657','90658','90660','90662','90669',
'90670','90696','90698','90700','90701','90707','90710','90713',
'90714','90715','90716','90718','90721','90723','90732','90733',
'90734','90736','90744','90746','99381','99382','99383','99384',
'99385','99386','99387','99391','99392','99393','99394','99395',
'99396','99397','G0101','G0102','G0103','G0123','G0124','G0145',
'G0202','G0328','P3000','P3001','Q0091','S0302','S3620','2000F',
'82465','3017F','G0105','81528','1220F','3725F','G8431','G0444',
'G8777','0403T','0488T','G0447','G0449','1030F','90719','G0296',
'90705','90708','90644','90389','90703','90704','90705','90706'),'Yes','No')) as Preventive_flag_Yr_1
FROM hap_ddr_raw.zz_obj_MSK_CB_Cohort_Label_HJ c
LEFT JOIN hap_ddr_raw.compass_claims_rollup_2019 a
ON a.partneremployerid = c.partneremployerid
AND a.patient_key = c.patient_key
LEFT JOIN edh_analytic_solutions_db.compass_claims_raw_cpt_hcpcs_procedure b
ON a.cpt_hcpcs_procedure_key = b.cpt_hcpcs_procedure_key 
GROUP BY 1,2,3,4
)
#############################################################################################Total rows - 664653
####################################################################################

Create table hap_ddr_raw.zz_part2_f19_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21 
,MAX(if (b.diagnosis_code in (
'311','1530','1531','1532','1533','1534','1535','1536','1537','1538','1539',
'1560','1561','1562','1568','1569','1740','1741','1742','1743','1744','1745',
'1746','1748','1749','1750','1759','2720','2721','2722','2723','2724','2725',
'2726','2727','2728','2729','2772','2781','2782','2783','2784','2788','4010',
'4011','4019','4142','4143','4148','4280','4281','4289','4292','5734','5738',
'5739','5750','5752','5753','5754','5755','5756','5758','5759','5851','5852',
'5853','5854','5855','5856','5859','25000','25001','25002','25003','25010',
'25011','25012','25013','25020','25021','25022','25023','25030','25031','25032',
'25033','25040','25041','25042','25043','25050','25051','25052','25053','25060',
'25061','25062','25063','25070','25071','25072','25073','25080','25081','25082',
'25083','25090','25091','25092','25093','27800','27801','27802','27803','41400',
'41401','41402','41403','41404','41405','41406','41407','42820','42821','42822',
'42823','42830','42831','42832','42833','42840','42841','42842','42843','43301',
'43311','43320','43321','43331','43381','43391','43401','43411','43491','57510',
'57511','57512','71500','71504','71509','71510','71511','71512','71513','71514',
'71515','71516','71517','71518','71520','71521','71522','71523','71524','71525',
'71526','71527','71528','71530','71531','71532','71533','71534','71535','71536',
'71537','71538','71580','71589','71590','71591','71592','71593','71594','71595',
'71596','71597','71598','78050','78051','78052','78053','78054','78055','78056',
'78057','78059'),'Yes','No')) as Comorbidity_flag_Yr_1
FROM hap_ddr_raw.zz_obj_MSK_CB_Cohort_Label_HJ c
LEFT JOIN hap_ddr_raw.compass_claims_rollup_2019 a
ON a.partneremployerid = c.partneremployerid
AND a.patient_key = c.patient_key
LEFT JOIN edh_analytic_solutions_db.compass_claims_raw_diagnosis b
ON a.diagnosis_key = b.diagnosis_key
GROUP BY 1,2,3,4
)
############################################################################################Total rows - 664653
#############

Create table hap_ddr_raw.zz_part3_f19_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21  
,MAX(if(b.diagnosis_code in (
'140','141','142','143','144','145','146','147','148','149','150','151','152','153','154','155',
'156','157','158','159','160','161','162','163','164','165','170','171','172','173','174','175',
'179','180','181','182','183','184','185','186','187','188','189','190','191','192', '193','194',
'195','199','390','393','412','430','431','436','449','452','1400','1401','1403','1404','1405',
'1406','1408','1409','1410','1411','1412','1413','1414','1415','1416','1418','1419','1420','1421','1422',
'1428','1429','1430','1431','1438','1439','1440','1441','1448','1449','1450','1451','1452','1453','1454',
'1455','1456','1458','1459','1460','1461','1462','1463','1464','1465','1466','1467','1468','1469','1470',
'1471','1472','1473','1478','1479','1480','1481','1482','1483','1488','1489','1490','1491','1498','1499',
'1500','1501','1502','1503','1504','1505','1508','1509','1510','1511','1512','1513','1514','1515','1516',
'1518','1519','1520','1521','1522','1523','1528','1529','1530','1531','1532','1533','1534','1535','1536',
'1537','1538','1539','1540','1541','1542','1543','1548','1550','1551','1560','1561','1562','1568','1569',
'1570','1571','1572','1573','1574','1578','1579','1580','1588','1589','1590','1591','1598','1599','1600',
'1601','1602','1603','1604','1605','1608','1609','1610','1611','1612','1613','1618','1619','1620','1622',
'1623','1624','1625','1628','1629','1630','1631','1638','1639','1640','1641','1642','1643','1648','1649',
'1650','1658','1659','1700','1701','1702','1703','1704','1705','1706','1710','1712','1713','1714','1715',
'1716','1717','1718','1719','1730','1731','1732','1733','1734','1735','1736','1737','1738','1739','1740',
'1741','1742','1743','1744','1745','1746','1748','1749','1750','1759','1800','1801','1808','1809','1820',
'1821','1828','1830','1832','1833','1834','1835','1838','1839','1840','1841','1842','1843','1844','1848',
'1849','1860','1869','1871','1872','1873','1874','1875','1876','1877','1878','1879','1880','1881','1882',
'1883','1884','1885','1886','1887','1888','1889','1890','1891','1892','1893','1894','1898','1899','1900',
'1901','1902','1903','1904','1905','1906','1907','1908','1909','1910','1911','1912','1913','1914','1915',
'1916','1917','1918','1919','1920','1921','1922','1923','1928','1929','1940','1941','1943','1944','1945',
'1946','1948','1949','1950','1951','1952','1953','1954','1955','1958','1990','1991','1992','2001','2002',
'2003','2004','2005','2006','2007','2008','2011','2012','2014','2015','2016','2017','2019','2021','2022',
'2023','2024','2025','2026','2027','2028','2029','2031','2038','2041','2042','2048','2049','2051','2052',
'2053','2058','2059','2061','2062','2068','2069','2071','2072','2078','2081','2082','2088','2089','2091',
'2092','2093','2332','2377','2384','2781','2782','2783','2784','2788','3910','3911','3912','3918','3919',
'3920','3929','3940','3941','3942','3949','3950','3951','3952','3959','3960','3961','3962','3963','3968',
'3969','3970','3971','3979','3980','4010','4011','4019','4110','4111','4130','4131','4139','4142','4143',
'4144','4148','4149','4150','4160','4161','4162','4168','4169','4170','4171','4178','4179','4200','4210',
'4211','4219','4220','4230','4231','4232','4233','4238','4239','4240','4241','4242','4243','4250','4252',
'4253','4254','4255','4257','4258','4259','4260','4262','4263','4264','4266','4267','4269','4270','4271',
'4272','4275','4279','4280','4281','4289','4290','4291','4292','4293','4294','4295','4296','4299','4320',
'4321','4329','4350','4351','4352','4353','4358','4359','4370','4371','4372','4373','4374','4375','4376',
'4377','4378','4379','4380','4386','4387','4389','4400','4401','4404','4408','4409','4411','4412','4413',
'4414','4415','4416','4417','4419','4420','4421','4422','4423','4429','4430','4431','4439','4441','4449',
'4460','4461','4463','4464','4465','4466','4467','4470','4471','4472','4473','4474','4475','4476','4478',
'4479','4480','4481','4489','4510','4512','4519','4530','4531','4532','4533','4536','4539','4540','4541',
'4542','4548','4549','4550','4551','4552','4553','4554','4555','4556','4557','4558','4559','4560','4561',
'4563','4564','4565','4566','4568','4570','4571','4572','4578','4579','4580','4581','4588','4589','4590',
'4592','4599','7140','7141','7142','7144','7149','7200','7201','7202','7209','20000','20001','20002','20003','20004','20005',
'20006','20007','20008','20010','20011','20012','20013','20014','20015','20016','20017','20018','20020','20021',
'20022','20023','20024','20025','20026','20027','20028','20030','20031','20032','20033','20034','20035','20036',
'20037','20038','20040','20041','20042','20043','20044','20045','20046','20047','20048','20050','20051','20052',
'20053','20054','20055','20056','20057','20058','20060','20061','20062','20063','20064','20065','20066','20067',
'20068','20070','20071','20072','20073','20074','20075','20076','20077','20078','20080','20081','20082','20083',
'20084','20085','20086','20087','20088','20100','20101','20102','20103','20104','20105','20106','20107','20108',
'20110','20111','20112','20113','20114','20115','20116','20117','20118','20120','20121','20122','20123','20124',
'20125','20126','20127','20128','20140','20141','20142','20143','20144','20145','20146','20147','20148','20150',
'20151','20152','20153','20154','20155','20156','20157','20158','20160','20161','20162','20163','20164','20165',
'20166','20167','20168','20170','20171','20172','20173','20174','20175','20176','20177','20178','20190','20191',
'20192','20193','20194','20195','20196','20197','20198','20200','20201','20202','20203','20204','20205','20206',
'20207','20208','20210','20211','20212','20213','20214','20215','20216','20217','20218','20220','20221','20222',
'20223','20224','20225','20226','20227','20228','20230','20231','20232','20233','20234','20235','20236','20237',
'20238','20240','20241','20242','20243','20244','20245','20246','20247','20248','20250','20251','20252','20253',
'20254','20255','20256','20257','20258','20260','20261','20262','20263','20264','20265','20266','20267','20268',
'20270','20271','20272','20273','20274','20275','20276','20277','20278','20280','20281','20282','20283','20284',
'20285','20286','20287','20288','20290','20291','20292','20293','20294','20295','20296','20297','20298','20300',
'20302','20310','20312','20380','20382','20400','20402','20410','20412','20420','20422','20480','20482','20490',
'20492','20500','20502','20510','20512','20520','20522','20530','20532','20580','20582','20590','20592','20600',
'20602','20610','20612','20620','20622','20680','20682','20690','20692','20700','20702','20710','20712','20720',
'20722','20780','20782','20800','20802','20810','20812','20820','20822','20880','20882','20890','20892','20900',
'20901','20902','20903','20910','20911','20912','20913','20914','20915','20916','20917','20920','20921','20922',
'20923','20924','20925','20926','20927','20929','20930','20931','20932','20933','20934','20935','20936','23770',
'23771','23772','23773','23779','23871','23872','23873','23874','23875','23876','23877','23879','25000','25001',
'25002','25003','25010','25011','25012','25013','25020','25021','25022','25023','25030','25031','25032','25033',
'25040','25041','25042','25043','25050','25051','25052','25053','25060','25061','25062','25063','25070','25071',
'25072','25073','25080','25081','25082','25083','25090','25091','25092','25093','27800','27801','27802','27803',
'39890','39891','39899','40200','40201','40210','40211','40290','40291','40300','40301','40310','40311','40390',
'40391','40400','40401','40402','40403','40410','40411','40412','40413','40490','40491','40492','40493','40501',
'40509','40511','40519','40591','40599','41000','41001','41002','41010','41011','41012','41020','41021','41022',
'41030','41031','41032','41040','41041','41042','41050','41051','41052','41060','41061','41062','41070','41071',
'41072','41080','41081','41082','41090','41091','41092','41181','41189','41400','41401','41402','41403','41404',
'41405','41406','41407','41410','41411','41412','41419','41511','41512','41513','41519','42090','42091','42099',
'42290','42291','42292','42293','42299','42490','42491','42499','42511','42518','42610','42611','42612','42613',
'42650','42651','42652','42653','42654','42681','42682','42689','42731','42732','42741','42742','42760','42761',
'42769','42781','42789','42820','42821','42822','42823','42830','42831','42832','42833','42840','42841','42842',
'42843','42971','42979','42981','42982','42983','42989','43300','43301','43310','43311','43320','43321','43330',
'43331','43380','43381','43390','43391','43400','43401','43410','43411','43490','43491','43810','43811','43812',
'43813','43814','43819','43820','43821','43822','43830','43831','43832','43840','43841','43842','43850','43851',
'43852','43853','43881','43882','43883','43884','43885','43889','44020','44021','44022','44023','44024','44029',
'44030','44031','44032','44100','44101','44102','44103','44281','44282','44283','44284','44289','44321','44322',
'44323','44324','44329','44381','44382','44389','44401','44409','44421','44422','44481','44489','44501','44502',
'44581','44589','44620','44621','44629','44770','44771','44772','44773','45111','45119','45181','45182','45183',
'45184','45189','45340','45341','45342','45350','45351','45352','45371','45372','45373','45374','45375','45376',
'45377','45379','45381','45382','45383','45384','45385','45386','45387','45389','45620','45621','45821','45829',
'45910','45911','45912','45913','45919','45930','45931','45932','45933','45939','45981','45989','71430','71431',
'71432','71433','71481','71489','73741','73742','73743','V1004','V1009','V1042', 'V1043','V1046', 'V1051','V1052','V1053',
'V1059', 'V1082','V1083','V1084','V1085','V1086','V1091','V1272','V151','V160','V161','V163','V1640','V1641','V1642',
'V1649','V1651','V1652','V1659','V166','V167','V168','V1811','V1819','V1851','V189','V421','V422','V4321','V4322','V433',
'V434','V4500','V4501', 'V4502', 'V4509', 'V4581','V4582','V4588','V472','V524','V5331','V5332', 'V5339','V581', 'V5861',
'V5863', 'V5866','V5873', 'V5881','V5882','V672','V711'),'Yes','No')) as Chronic_flag_Yr_1 
FROM hap_ddr_raw.zz_obj_MSK_CB_Cohort_Label_HJ c
LEFT JOIN hap_ddr_raw.compass_claims_rollup_2019 a
ON a.partneremployerid = c.partneremployerid
AND a.patient_key = c.patient_key
LEFT JOIN edh_analytic_solutions_db.compass_claims_raw_diagnosis b
ON a.diagnosis_key = b.diagnosis_key
GROUP BY 1,2,3,4
)


Create table hap_ddr_raw.zz_part4_f19_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21  
,MAX(if( b.diagnosis_key in (4,5,6,71,90,91,92,93,94,95,96,97,98,101,102,103,104,107,108,109,110,111,112,113,114,116,117,118,120,121,122,123,124,125,
127,128,129,131,132,137,138,140,143,146,148,149,152,153,157,158,164,165,166,167,170,177,179,180,181,185,187,189,191,192,1147,1180,1189,1190,4168,4174,
4226,4227,4233,4236,4238,4240,4242,4244,4245,4254,4258,4261,4262,4263,4264,4268,4269,4271,4272,4273,4274,4300,5488,5492,5720,5721,5722,5725,5726,5727,
5728,5734,5735,5738,5739,5744,5751,5757,5759,5770,5771,5774,5776,5782,5783,5784,5785,5786,5792,5810,5811,5812,5825,5827,5831,5844,6776,6804,6846,6849,
6850,7034,7239,7240,7241,7261,7286,7315,7319,7572,7573,7583,7587,7588,7589,7593,7595,7599,7600,7611,7616,7625,7639,7647,7649,7651,7653,7654,8193,8213,
8214,8229,8235,8236,8238,8255,8256,8263,8264,8267,8269,8275,8276,8277,8279,8285,8286,8289,8293,8309,8310,9049,9050,9051,9052,9053,9054,9055,9057,9058,
9061,9062,9099,9100,9101,10234,10239,10242,11120,11126,11129,11130,11132,11133,11135,11136,11138,11141,11142,11143,11144,11145,11146,11147,11148,11149,
11152,11153,11154,11155,11156,11157,11159,11160,11161,11162,11164,11165,11166,11168,11169,11170,11172,11174,11175,11176,11177,11178,11179,11180,11181,
11182,11185,11187,11189,11331,11471,11472,11474,11504,11513,11515,11518,11532,11534,11537,11543,11547,11549,11551,11561,11566,11569,11577,11578,11579,
11580,11584,11585,11586,11618,11625,11639,11642,11643,11645,11651,11652,11653,11654,11655,11656,11657,11658,11659,11661,11662,11663,11667,11671,11675,
11676,11677,11678,11679,11681,11683,12338,12348,12365,12416,12418,12419,12430,13054,14578,14579,14616,14618,14621,14626,14633,14637,14642,14656,14666,
14667,14668,14669,14672,14681,14683,14697,14698,14704,14707,14708,14711,14713,14714,14720,14723,14725,14727,14756,14757,14758,14759,14760,14763,14764,
14765,14766,14767,14768,14769,14770,14773,14774,14775,14776,14777,14783,14786,14790,14798,14800,14804,15256,15262,15271,15272,15273,15280,15281,15538,
15544,15554,15560,15564,15592,16740,16745,16747,16757) AND 
b.diagnosis_code in 
("8485","8488","8489","7261","7260","72610","72611","72612","72619","7262","72630","72631","72632","7264","7265","72660","72661","72664","72665","72669",
"72670","72671","72672","72673","72679","72690","72691","72700","72703","72704","72705","72706","72709","7271","7273","72740","72741","72743","72749",
"72761","72762","72764","72767","72781","72783","72789","7291","7292","7294","7295","72981","72982","72989","72990","72999","7282","7284","7285","72871",
"72883","72885","72887","72889","7289","9551","9578","9532","9533","71611","71617","71690","71691","71697","71500","71509","71511","71513","71515","71516",
"71526","71531","71534","71535","71536","71537","71590","71591","71593","71594","71595","71596","7104","9593","9597","83900","83901","83902","83905","83906",
"83907","83908","83915","83916","83920","83921","83942","83969","83301","83303","83100","83101","83104","83110","8360","8361","8362","8363","8364","83659",
"83801","83802","83803","83400","83402","83200","8370","82300","82301","82332","82380","82381","82382","8220","82100","82120","82121","82520","82525","8260",
"82022","8242","8244","8246","8248","8249","8171","81305","81306","81323","81341","81342","81344","81600","81601","81500","81501","81504","81510","81200",
"81201","81202","81209","81220","81221","81240","81244","81400","81401","7230","7231","7232","7233","7234","7235","7236","7238","7239","72402","72403","7200",
"7201","7202","9052","9057","9070","840","8451","84200","84201","84209","84210","84212","84213","8400","8403","8404","8405","8406","8407","8408","8409","8460",
"8461","8468","8469","8470","8471","8472","8473","8479","8440","8441","8442","8448","8449","8430","8438","8439","8410","8412","8418","8419","84500","84501",
"84502","84503","84509","84510","84511","84519","8481","8483","9950","73740","73741","73743","73302","73316","73320","73329","73390","73392","73395","73810",
"7382","7384","7386","73606","73621","73630","73670","73671","73672","73673","73679","73681","73689","73030","73037","7321","7324","7325","7327","7390","7391",
"7392","7393","7394","7395","7396","7397","7398","734","7370","73710","73720","73730","73734","73739","7378","7379","7350","7352","7354","8760","8950","8910",
"8822","8831","8832","8841","94400","7194","7195","7140","7142","71432","7149","71807","71811","71817","71831","71841","71842","71843","71844","71847","71856",
"71858","71880","71881","71887","71890","71891","71894","71897","71898","71904","71907","71909","71911","71940","71941","71942","71943","71944","71947","71948",
"71949","71950","71951","71952","71953","71954","71957","71958","71959","71960","71961","71967","7197","71983","71991","71993","71997","92300","92311","92231",
"92232","92233","92411","92420","99851","99883","9962","99642","99646","99677","85400","85405","85409","85011"),'Yes','No')) as Diagnosis_flag_Yr_1
FROM hap_ddr_raw.zz_obj_MSK_CB_Cohort_Label_HJ c
LEFT JOIN hap_ddr_raw.compass_claims_rollup_2019 a
ON a.partneremployerid = c.partneremployerid
AND a.patient_key = c.patient_key
LEFT JOIN edh_analytic_solutions_db.compass_claims_raw_diagnosis b
ON a.diagnosis_key = b.diagnosis_key
GROUP BY 1,2,3,4
)

---------------------------------------------------------- 664653
create table hap_ddr_raw.zz_part5_f19_HJ 
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21  
,MAX(if(b.cpt_hcpcs_procedure_key in (8728,8729,9370,9372,9373,9374,9375,9376,9377,9378,
9379,9380,9381,9382,9385,9386,9387,9388,9389,9391,9392,9393,9399,9400,9415,9416,9417,9418,
11920,15297,15298,19142,20139)
AND b.cpt_hcpcs_procedure_code in ("90901","90911","97010","97014","97016","97018","97022",
"97024","97026","97028","97032","97033","97034","97035","97110","97112","97113","97116","97124",
"97140","97150","97530","97545","97546","97810","97811","97813","97814","G0129","S8950","S8990",
"S8930","PTBUN"),'Yes','No')) as Procedure_flag_Yr_1
FROM hap_ddr_raw.zz_obj_MSK_CB_Cohort_Label_HJ c
LEFT JOIN hap_ddr_raw.compass_claims_rollup_2019 a
ON a.partneremployerid = c.partneremployerid
AND a.patient_key = c.patient_key
LEFT JOIN edh_analytic_solutions_db.compass_claims_raw_cpt_hcpcs_procedure b
ON a.cpt_hcpcs_procedure_key = b.cpt_hcpcs_procedure_key 
GROUP BY 1,2,3,4
)

############################################################################################################################
###############################################################################################################
###############################################################################################################
**********************
****EDA FULL 2020*****
******************************************************************
****Costs & Flags *Preventive Codes**Comorbidity  Codes**Chronic  Codes*
*****************************************************************

create table hap_ddr_raw.zz_obj_CB_partcost20_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21 
,MAX(if(b.h1_rollup_description = 'Mental disorders','Yes','No')) as MH_flag_Yr_0
,MAX(if(bt.chronic_or_acute='chronic' AND bt.surgery_solution='Surgery Solution' AND (bt.knee='Y' OR bt.hip='Y' OR bt.spine='Y'),'Yes','No')) as MSK_CKHBSurgery_flag_Yr_0
,MAX(if(bt.chronic_or_acute='chronic' AND (bt.knee='Y' OR bt.hip='Y'),'Yes','No')) as MSK_CKHNoSurgery_flag_Yr_0
,MAX(if(bt.chronic_or_acute='chronic' AND bt.spine='Y','Yes','No')) as MSK_CBNoSurgery_flag_Yr_0
,if(SUM(amount_allowed) > 10000,'Yes','No') as HS_flag_Yr_0 
,SUM(a.amount_allowed) as tot_billed_amt_Yr_0 
,AVG(a.amount_allowed) as avg_billed_amt_Yr_0 
,STDDEV(a.amount_allowed) as std_billed_amt_Yr_0 
,MAX(a.amount_allowed) as max_billed_amt_Yr_0 
,SUM(a.amount_Plan) as  employer_paid_Yr_0 
,SUM(a.amount_Employee_Copay) as employee_paid1_Yr_0 
,SUM(a.amount_Employee_Coinsurance) as employee_paid2_Yr_0 
,SUM(a.amount_Employee_Deductible) as paid_thr_deduct_Yr_0 
FROM hap_ddr_raw.zz_obj_MSK_CB_Cohort_Label_HJ c
LEFT JOIN hap_ddr_raw.compass_claims_rollup_2020 a
ON a.patient_key = c.patient_key
AND a.partneremployerid = c.partneremployerid
LEFT JOIN edh_analytic_solutions_db.compass_claims_raw_diagnosis b
ON a.diagnosis_key = b.diagnosis_key
LEFT JOIN hap_ddr_raw.MSK_input_20220707 bt
ON b.diagnosis_code_description = bt.diagnosis_code
GROUP BY 1,2,3,4
)

###################################################################################################################################
Create table hap_ddr_raw.zz_part1_f20_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21 
,MAX(if(b.cpt_hcpcs_procedure_key in (4500,
6987,8610,8611,8612,8613,8615,8617,8618,8619,8622,8623,8624,
8625,8626,8628,8634,8635,8644,8645,8646,8647,8653,8655,8657,
8658,8659,8660,8662,8665,8666,8669,8670,8671,8673,8677,8678,
9570,9571,9572,9573,9574,9575,9576,9577,9578,9579,9580,9581,
9582,9583,11894,11895,11896,11915,11916,11925,11945,12050,14589,
14590,14639,14965,15105,948,7494,2616,11898,18077,691,3700,12444,
16925,17235,18444,19614,16928,16930,494,8663,12019,8651,8654,8614,
8595,8649,8650,8651,8652)
AND b.cpt_hcpcs_procedure_code in ('45378',
'77057','90632','90633','90634','90636','90645','90647','90648',
'90649','90655','90656','90657','90658','90660','90662','90669',
'90670','90696','90698','90700','90701','90707','90710','90713',
'90714','90715','90716','90718','90721','90723','90732','90733',
'90734','90736','90744','90746','99381','99382','99383','99384',
'99385','99386','99387','99391','99392','99393','99394','99395',
'99396','99397','G0101','G0102','G0103','G0123','G0124','G0145',
'G0202','G0328','P3000','P3001','Q0091','S0302','S3620','2000F',
'82465','3017F','G0105','81528','1220F','3725F','G8431','G0444',
'G8777','0403T','0488T','G0447','G0449','1030F','90719','G0296',
'90705','90708','90644','90389','90703','90704','90705','90706'),'Yes','No')) as Preventive_flag_Yr_0
FROM hap_ddr_raw.zz_obj_MSK_CB_Cohort_Label_HJ c
LEFT JOIN hap_ddr_raw.compass_claims_rollup_2020 a
ON a.partneremployerid = c.partneremployerid
AND a.patient_key = c.patient_key
LEFT JOIN edh_analytic_solutions_db.compass_claims_raw_cpt_hcpcs_procedure b
ON a.cpt_hcpcs_procedure_key = b.cpt_hcpcs_procedure_key 
GROUP BY 1,2,3,4
)
#########################################################################################################

Create table hap_ddr_raw.zz_part2_f20_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21
,MAX(if(b.diagnosis_code in (
'311','1530','1531','1532','1533','1534','1535','1536','1537','1538','1539',
'1560','1561','1562','1568','1569','1740','1741','1742','1743','1744','1745',
'1746','1748','1749','1750','1759','2720','2721','2722','2723','2724','2725',
'2726','2727','2728','2729','2772','2781','2782','2783','2784','2788','4010',
'4011','4019','4142','4143','4148','4280','4281','4289','4292','5734','5738',
'5739','5750','5752','5753','5754','5755','5756','5758','5759','5851','5852',
'5853','5854','5855','5856','5859','25000','25001','25002','25003','25010',
'25011','25012','25013','25020','25021','25022','25023','25030','25031','25032',
'25033','25040','25041','25042','25043','25050','25051','25052','25053','25060',
'25061','25062','25063','25070','25071','25072','25073','25080','25081','25082',
'25083','25090','25091','25092','25093','27800','27801','27802','27803','41400',
'41401','41402','41403','41404','41405','41406','41407','42820','42821','42822',
'42823','42830','42831','42832','42833','42840','42841','42842','42843','43301',
'43311','43320','43321','43331','43381','43391','43401','43411','43491','57510',
'57511','57512','71500','71504','71509','71510','71511','71512','71513','71514',
'71515','71516','71517','71518','71520','71521','71522','71523','71524','71525',
'71526','71527','71528','71530','71531','71532','71533','71534','71535','71536',
'71537','71538','71580','71589','71590','71591','71592','71593','71594','71595',
'71596','71597','71598','78050','78051','78052','78053','78054','78055','78056',
'78057','78059'),'Yes','No')) as Comorbidity_flag_Yr_0
FROM hap_ddr_raw.zz_obj_MSK_CB_Cohort_Label_HJ c
LEFT JOIN hap_ddr_raw.compass_claims_rollup_2020 a
ON a.partneremployerid = c.partneremployerid
AND a.patient_key = c.patient_key
LEFT JOIN edh_analytic_solutions_db.compass_claims_raw_diagnosis b
ON a.diagnosis_key = b.diagnosis_key
GROUP BY 1,2,3,4
)
#########################################################################################################

Create table hap_ddr_raw.zz_part3_f20_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21 
,MAX(if(b.diagnosis_code in (
'140','141','142','143','144','145','146','147','148','149','150','151','152','153','154','155',
'156','157','158','159','160','161','162','163','164','165','170','171','172','173','174','175',
'179','180','181','182','183','184','185','186','187','188','189','190','191','192', '193','194',
'195','199','390','393','412','430','431','436','449','452','1400','1401','1403','1404','1405',
'1406','1408','1409','1410','1411','1412','1413','1414','1415','1416','1418','1419','1420','1421','1422',
'1428','1429','1430','1431','1438','1439','1440','1441','1448','1449','1450','1451','1452','1453','1454',
'1455','1456','1458','1459','1460','1461','1462','1463','1464','1465','1466','1467','1468','1469','1470',
'1471','1472','1473','1478','1479','1480','1481','1482','1483','1488','1489','1490','1491','1498','1499',
'1500','1501','1502','1503','1504','1505','1508','1509','1510','1511','1512','1513','1514','1515','1516',
'1518','1519','1520','1521','1522','1523','1528','1529','1530','1531','1532','1533','1534','1535','1536',
'1537','1538','1539','1540','1541','1542','1543','1548','1550','1551','1560','1561','1562','1568','1569',
'1570','1571','1572','1573','1574','1578','1579','1580','1588','1589','1590','1591','1598','1599','1600',
'1601','1602','1603','1604','1605','1608','1609','1610','1611','1612','1613','1618','1619','1620','1622',
'1623','1624','1625','1628','1629','1630','1631','1638','1639','1640','1641','1642','1643','1648','1649',
'1650','1658','1659','1700','1701','1702','1703','1704','1705','1706','1710','1712','1713','1714','1715',
'1716','1717','1718','1719','1730','1731','1732','1733','1734','1735','1736','1737','1738','1739','1740',
'1741','1742','1743','1744','1745','1746','1748','1749','1750','1759','1800','1801','1808','1809','1820',
'1821','1828','1830','1832','1833','1834','1835','1838','1839','1840','1841','1842','1843','1844','1848',
'1849','1860','1869','1871','1872','1873','1874','1875','1876','1877','1878','1879','1880','1881','1882',
'1883','1884','1885','1886','1887','1888','1889','1890','1891','1892','1893','1894','1898','1899','1900',
'1901','1902','1903','1904','1905','1906','1907','1908','1909','1910','1911','1912','1913','1914','1915',
'1916','1917','1918','1919','1920','1921','1922','1923','1928','1929','1940','1941','1943','1944','1945',
'1946','1948','1949','1950','1951','1952','1953','1954','1955','1958','1990','1991','1992','2001','2002',
'2003','2004','2005','2006','2007','2008','2011','2012','2014','2015','2016','2017','2019','2021','2022',
'2023','2024','2025','2026','2027','2028','2029','2031','2038','2041','2042','2048','2049','2051','2052',
'2053','2058','2059','2061','2062','2068','2069','2071','2072','2078','2081','2082','2088','2089','2091',
'2092','2093','2332','2377','2384','2781','2782','2783','2784','2788','3910','3911','3912','3918','3919',
'3920','3929','3940','3941','3942','3949','3950','3951','3952','3959','3960','3961','3962','3963','3968',
'3969','3970','3971','3979','3980','4010','4011','4019','4110','4111','4130','4131','4139','4142','4143',
'4144','4148','4149','4150','4160','4161','4162','4168','4169','4170','4171','4178','4179','4200','4210',
'4211','4219','4220','4230','4231','4232','4233','4238','4239','4240','4241','4242','4243','4250','4252',
'4253','4254','4255','4257','4258','4259','4260','4262','4263','4264','4266','4267','4269','4270','4271',
'4272','4275','4279','4280','4281','4289','4290','4291','4292','4293','4294','4295','4296','4299','4320',
'4321','4329','4350','4351','4352','4353','4358','4359','4370','4371','4372','4373','4374','4375','4376',
'4377','4378','4379','4380','4386','4387','4389','4400','4401','4404','4408','4409','4411','4412','4413',
'4414','4415','4416','4417','4419','4420','4421','4422','4423','4429','4430','4431','4439','4441','4449',
'4460','4461','4463','4464','4465','4466','4467','4470','4471','4472','4473','4474','4475','4476','4478',
'4479','4480','4481','4489','4510','4512','4519','4530','4531','4532','4533','4536','4539','4540','4541',
'4542','4548','4549','4550','4551','4552','4553','4554','4555','4556','4557','4558','4559','4560','4561',
'4563','4564','4565','4566','4568','4570','4571','4572','4578','4579','4580','4581','4588','4589','4590',
'4592','4599','7140','7141','7142','7144','7149','7200','7201','7202','7209','20000','20001','20002','20003','20004','20005',
'20006','20007','20008','20010','20011','20012','20013','20014','20015','20016','20017','20018','20020','20021',
'20022','20023','20024','20025','20026','20027','20028','20030','20031','20032','20033','20034','20035','20036',
'20037','20038','20040','20041','20042','20043','20044','20045','20046','20047','20048','20050','20051','20052',
'20053','20054','20055','20056','20057','20058','20060','20061','20062','20063','20064','20065','20066','20067',
'20068','20070','20071','20072','20073','20074','20075','20076','20077','20078','20080','20081','20082','20083',
'20084','20085','20086','20087','20088','20100','20101','20102','20103','20104','20105','20106','20107','20108',
'20110','20111','20112','20113','20114','20115','20116','20117','20118','20120','20121','20122','20123','20124',
'20125','20126','20127','20128','20140','20141','20142','20143','20144','20145','20146','20147','20148','20150',
'20151','20152','20153','20154','20155','20156','20157','20158','20160','20161','20162','20163','20164','20165',
'20166','20167','20168','20170','20171','20172','20173','20174','20175','20176','20177','20178','20190','20191',
'20192','20193','20194','20195','20196','20197','20198','20200','20201','20202','20203','20204','20205','20206',
'20207','20208','20210','20211','20212','20213','20214','20215','20216','20217','20218','20220','20221','20222',
'20223','20224','20225','20226','20227','20228','20230','20231','20232','20233','20234','20235','20236','20237',
'20238','20240','20241','20242','20243','20244','20245','20246','20247','20248','20250','20251','20252','20253',
'20254','20255','20256','20257','20258','20260','20261','20262','20263','20264','20265','20266','20267','20268',
'20270','20271','20272','20273','20274','20275','20276','20277','20278','20280','20281','20282','20283','20284',
'20285','20286','20287','20288','20290','20291','20292','20293','20294','20295','20296','20297','20298','20300',
'20302','20310','20312','20380','20382','20400','20402','20410','20412','20420','20422','20480','20482','20490',
'20492','20500','20502','20510','20512','20520','20522','20530','20532','20580','20582','20590','20592','20600',
'20602','20610','20612','20620','20622','20680','20682','20690','20692','20700','20702','20710','20712','20720',
'20722','20780','20782','20800','20802','20810','20812','20820','20822','20880','20882','20890','20892','20900',
'20901','20902','20903','20910','20911','20912','20913','20914','20915','20916','20917','20920','20921','20922',
'20923','20924','20925','20926','20927','20929','20930','20931','20932','20933','20934','20935','20936','23770',
'23771','23772','23773','23779','23871','23872','23873','23874','23875','23876','23877','23879','25000','25001',
'25002','25003','25010','25011','25012','25013','25020','25021','25022','25023','25030','25031','25032','25033',
'25040','25041','25042','25043','25050','25051','25052','25053','25060','25061','25062','25063','25070','25071',
'25072','25073','25080','25081','25082','25083','25090','25091','25092','25093','27800','27801','27802','27803',
'39890','39891','39899','40200','40201','40210','40211','40290','40291','40300','40301','40310','40311','40390',
'40391','40400','40401','40402','40403','40410','40411','40412','40413','40490','40491','40492','40493','40501',
'40509','40511','40519','40591','40599','41000','41001','41002','41010','41011','41012','41020','41021','41022',
'41030','41031','41032','41040','41041','41042','41050','41051','41052','41060','41061','41062','41070','41071',
'41072','41080','41081','41082','41090','41091','41092','41181','41189','41400','41401','41402','41403','41404',
'41405','41406','41407','41410','41411','41412','41419','41511','41512','41513','41519','42090','42091','42099',
'42290','42291','42292','42293','42299','42490','42491','42499','42511','42518','42610','42611','42612','42613',
'42650','42651','42652','42653','42654','42681','42682','42689','42731','42732','42741','42742','42760','42761',
'42769','42781','42789','42820','42821','42822','42823','42830','42831','42832','42833','42840','42841','42842',
'42843','42971','42979','42981','42982','42983','42989','43300','43301','43310','43311','43320','43321','43330',
'43331','43380','43381','43390','43391','43400','43401','43410','43411','43490','43491','43810','43811','43812',
'43813','43814','43819','43820','43821','43822','43830','43831','43832','43840','43841','43842','43850','43851',
'43852','43853','43881','43882','43883','43884','43885','43889','44020','44021','44022','44023','44024','44029',
'44030','44031','44032','44100','44101','44102','44103','44281','44282','44283','44284','44289','44321','44322',
'44323','44324','44329','44381','44382','44389','44401','44409','44421','44422','44481','44489','44501','44502',
'44581','44589','44620','44621','44629','44770','44771','44772','44773','45111','45119','45181','45182','45183',
'45184','45189','45340','45341','45342','45350','45351','45352','45371','45372','45373','45374','45375','45376',
'45377','45379','45381','45382','45383','45384','45385','45386','45387','45389','45620','45621','45821','45829',
'45910','45911','45912','45913','45919','45930','45931','45932','45933','45939','45981','45989','71430','71431',
'71432','71433','71481','71489','73741','73742','73743','V1004','V1009','V1042', 'V1043','V1046', 'V1051','V1052','V1053',
'V1059', 'V1082','V1083','V1084','V1085','V1086','V1091','V1272','V151','V160','V161','V163','V1640','V1641','V1642',
'V1649','V1651','V1652','V1659','V166','V167','V168','V1811','V1819','V1851','V189','V421','V422','V4321','V4322','V433',
'V434','V4500','V4501', 'V4502', 'V4509', 'V4581','V4582','V4588','V472','V524','V5331','V5332', 'V5339','V581', 'V5861',
'V5863', 'V5866','V5873', 'V5881','V5882','V672','V711'),'Yes','No')) as Chronic_flag_Yr_0 
FROM hap_ddr_raw.zz_obj_MSK_CB_Cohort_Label_HJ c
LEFT JOIN hap_ddr_raw.compass_claims_rollup_2020 a
ON a.partneremployerid = c.partneremployerid
AND a.patient_key = c.patient_key
LEFT JOIN edh_analytic_solutions_db.compass_claims_raw_diagnosis b
ON a.diagnosis_key = b.diagnosis_key
GROUP BY 1,2,3,4
)

Create table hap_ddr_raw.zz_part4_f20_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21  
,MAX(if( b.diagnosis_key in (4,5,6,71,90,91,92,93,94,95,96,97,98,101,102,103,104,107,108,109,110,111,112,113,114,116,117,118,120,121,122,123,124,125,
127,128,129,131,132,137,138,140,143,146,148,149,152,153,157,158,164,165,166,167,170,177,179,180,181,185,187,189,191,192,1147,1180,1189,1190,4168,4174,
4226,4227,4233,4236,4238,4240,4242,4244,4245,4254,4258,4261,4262,4263,4264,4268,4269,4271,4272,4273,4274,4300,5488,5492,5720,5721,5722,5725,5726,5727,
5728,5734,5735,5738,5739,5744,5751,5757,5759,5770,5771,5774,5776,5782,5783,5784,5785,5786,5792,5810,5811,5812,5825,5827,5831,5844,6776,6804,6846,6849,
6850,7034,7239,7240,7241,7261,7286,7315,7319,7572,7573,7583,7587,7588,7589,7593,7595,7599,7600,7611,7616,7625,7639,7647,7649,7651,7653,7654,8193,8213,
8214,8229,8235,8236,8238,8255,8256,8263,8264,8267,8269,8275,8276,8277,8279,8285,8286,8289,8293,8309,8310,9049,9050,9051,9052,9053,9054,9055,9057,9058,
9061,9062,9099,9100,9101,10234,10239,10242,11120,11126,11129,11130,11132,11133,11135,11136,11138,11141,11142,11143,11144,11145,11146,11147,11148,11149,
11152,11153,11154,11155,11156,11157,11159,11160,11161,11162,11164,11165,11166,11168,11169,11170,11172,11174,11175,11176,11177,11178,11179,11180,11181,
11182,11185,11187,11189,11331,11471,11472,11474,11504,11513,11515,11518,11532,11534,11537,11543,11547,11549,11551,11561,11566,11569,11577,11578,11579,
11580,11584,11585,11586,11618,11625,11639,11642,11643,11645,11651,11652,11653,11654,11655,11656,11657,11658,11659,11661,11662,11663,11667,11671,11675,
11676,11677,11678,11679,11681,11683,12338,12348,12365,12416,12418,12419,12430,13054,14578,14579,14616,14618,14621,14626,14633,14637,14642,14656,14666,
14667,14668,14669,14672,14681,14683,14697,14698,14704,14707,14708,14711,14713,14714,14720,14723,14725,14727,14756,14757,14758,14759,14760,14763,14764,
14765,14766,14767,14768,14769,14770,14773,14774,14775,14776,14777,14783,14786,14790,14798,14800,14804,15256,15262,15271,15272,15273,15280,15281,15538,
15544,15554,15560,15564,15592,16740,16745,16747,16757) 
AND b.diagnosis_code in 
("8485","8488","8489","7261","7260","72610","72611","72612","72619","7262","72630","72631","72632","7264","7265","72660","72661","72664","72665","72669",
"72670","72671","72672","72673","72679","72690","72691","72700","72703","72704","72705","72706","72709","7271","7273","72740","72741","72743","72749",
"72761","72762","72764","72767","72781","72783","72789","7291","7292","7294","7295","72981","72982","72989","72990","72999","7282","7284","7285","72871",
"72883","72885","72887","72889","7289","9551","9578","9532","9533","71611","71617","71690","71691","71697","71500","71509","71511","71513","71515","71516",
"71526","71531","71534","71535","71536","71537","71590","71591","71593","71594","71595","71596","7104","9593","9597","83900","83901","83902","83905","83906",
"83907","83908","83915","83916","83920","83921","83942","83969","83301","83303","83100","83101","83104","83110","8360","8361","8362","8363","8364","83659",
"83801","83802","83803","83400","83402","83200","8370","82300","82301","82332","82380","82381","82382","8220","82100","82120","82121","82520","82525","8260",
"82022","8242","8244","8246","8248","8249","8171","81305","81306","81323","81341","81342","81344","81600","81601","81500","81501","81504","81510","81200",
"81201","81202","81209","81220","81221","81240","81244","81400","81401","7230","7231","7232","7233","7234","7235","7236","7238","7239","72402","72403","7200",
"7201","7202","9052","9057","9070","840","8451","84200","84201","84209","84210","84212","84213","8400","8403","8404","8405","8406","8407","8408","8409","8460",
"8461","8468","8469","8470","8471","8472","8473","8479","8440","8441","8442","8448","8449","8430","8438","8439","8410","8412","8418","8419","84500","84501",
"84502","84503","84509","84510","84511","84519","8481","8483","9950","73740","73741","73743","73302","73316","73320","73329","73390","73392","73395","73810",
"7382","7384","7386","73606","73621","73630","73670","73671","73672","73673","73679","73681","73689","73030","73037","7321","7324","7325","7327","7390","7391",
"7392","7393","7394","7395","7396","7397","7398","734","7370","73710","73720","73730","73734","73739","7378","7379","7350","7352","7354","8760","8950","8910",
"8822","8831","8832","8841","94400","7194","7195","7140","7142","71432","7149","71807","71811","71817","71831","71841","71842","71843","71844","71847","71856",
"71858","71880","71881","71887","71890","71891","71894","71897","71898","71904","71907","71909","71911","71940","71941","71942","71943","71944","71947","71948",
"71949","71950","71951","71952","71953","71954","71957","71958","71959","71960","71961","71967","7197","71983","71991","71993","71997","92300","92311","92231",
"92232","92233","92411","92420","99851","99883","9962","99642","99646","99677","85400","85405","85409","85011"),'Yes','No')) as Diagnosis_flag_Yr_0
FROM hap_ddr_raw.zz_obj_MSK_CB_Cohort_Label_HJ c
LEFT JOIN hap_ddr_raw.compass_claims_rollup_2020 a
ON a.partneremployerid = c.partneremployerid
AND a.patient_key = c.patient_key
LEFT JOIN edh_analytic_solutions_db.compass_claims_raw_diagnosis b
ON a.diagnosis_key = b.diagnosis_key
GROUP BY 1,2,3,4
)

create table hap_ddr_raw.zz_part5_f20_HJ 
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21  
,MAX(if(b.cpt_hcpcs_procedure_key in (8728,8729,9370,9372,9373,9374,9375,9376,9377,9378,
9379,9380,9381,9382,9385,9386,9387,9388,9389,9391,9392,9393,9399,9400,9415,9416,9417,9418,
11920,15297,15298,19142,20139)
AND b.cpt_hcpcs_procedure_code in ("90901","90911","97010","97014","97016","97018","97022",
"97024","97026","97028","97032","97033","97034","97035","97110","97112","97113","97116","97124",
"97140","97150","97530","97545","97546","97810","97811","97813","97814","G0129","S8950","S8990",
"S8930","PTBUN"),'Yes','No')) as Procedure_flag_Yr_0
FROM hap_ddr_raw.zz_obj_MSK_CB_Cohort_Label_HJ c
LEFT JOIN hap_ddr_raw.compass_claims_rollup_2020 a
ON a.partneremployerid = c.partneremployerid
AND a.patient_key = c.patient_key
LEFT JOIN edh_analytic_solutions_db.compass_claims_raw_cpt_hcpcs_procedure b
ON a.cpt_hcpcs_procedure_key = b.cpt_hcpcs_procedure_key 
GROUP BY 1,2,3,4
)


############################################################################################################################
###############################################################################################################
###############################################################################################################
**********************
****EDA FULL 2021*****
******************************************************************
****Costs & Flags *Preventive Codes**Comorbidity  Codes**Chronic  Codes*
*****************************************************************

create table hap_ddr_raw.zz_obj_CB_partcost21_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21 
,MAX(if(b.h1_rollup_description = 'Mental disorders','Yes','No')) as MH_flag_Yr
,MAX(if(bt.chronic_or_acute='chronic' AND bt.surgery_solution='Surgery Solution' AND (bt.knee='Y' OR bt.hip='Y' OR bt.spine='Y'),'Yes','No')) as MSK_CKHBSurgery_flag_Yr
,MAX(if(bt.chronic_or_acute='chronic' AND (bt.knee='Y' OR bt.hip='Y'),'Yes','No')) as MSK_CKHNoSurgery_flag_Yr
,MAX(if(bt.chronic_or_acute='chronic' AND bt.spine='Y','Yes','No')) as MSK_CBNoSurgery_flag_Yr
,if(SUM(amount_allowed) > 10000,'Yes','No') as HS_flag_Yr 
,SUM(a.amount_allowed) as tot_billed_amt_Yr
,AVG(a.amount_allowed) as avg_billed_amt_Yr
,STDDEV(a.amount_allowed) as std_billed_amt_Yr 
,MAX(a.amount_allowed) as max_billed_amt_Yr
,SUM(a.amount_Plan) as  employer_paid_Yr
,SUM(a.amount_Employee_Copay) as employee_paid1_Yr 
,SUM(a.amount_Employee_Coinsurance) as employee_paid2_Yr 
,SUM(a.amount_Employee_Deductible) as paid_thr_deduct_Yr 
FROM hap_ddr_raw.zz_obj_MSK_CB_Cohort_Label_HJ c
LEFT JOIN hap_ddr_raw.compass_claims_rollup_2021 a
ON a.patient_key = c.patient_key
AND a.partneremployerid = c.partneremployerid
LEFT JOIN edh_analytic_solutions_db.compass_claims_raw_diagnosis b
ON a.diagnosis_key = b.diagnosis_key
LEFT JOIN hap_ddr_raw.MSK_input_20220707 bt
ON b.diagnosis_code_description = bt.diagnosis_code
GROUP BY 1,2,3,4
)

###################################################################################################################################
Create table hap_ddr_raw.zz_part1_f21_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21 
,MAX(if(b.cpt_hcpcs_procedure_key in (4500,
6987,8610,8611,8612,8613,8615,8617,8618,8619,8622,8623,8624,
8625,8626,8628,8634,8635,8644,8645,8646,8647,8653,8655,8657,
8658,8659,8660,8662,8665,8666,8669,8670,8671,8673,8677,8678,
9570,9571,9572,9573,9574,9575,9576,9577,9578,9579,9580,9581,
9582,9583,11894,11895,11896,11915,11916,11925,11945,12050,14589,
14590,14639,14965,15105,948,7494,2616,11898,18077,691,3700,12444,
16925,17235,18444,19614,16928,16930,494,8663,12019,8651,8654,8614,
8595,8649,8650,8651,8652)
AND b.cpt_hcpcs_procedure_code in ('45378',
'77057','90632','90633','90634','90636','90645','90647','90648',
'90649','90655','90656','90657','90658','90660','90662','90669',
'90670','90696','90698','90700','90701','90707','90710','90713',
'90714','90715','90716','90718','90721','90723','90732','90733',
'90734','90736','90744','90746','99381','99382','99383','99384',
'99385','99386','99387','99391','99392','99393','99394','99395',
'99396','99397','G0101','G0102','G0103','G0123','G0124','G0145',
'G0202','G0328','P3000','P3001','Q0091','S0302','S3620','2000F',
'82465','3017F','G0105','81528','1220F','3725F','G8431','G0444',
'G8777','0403T','0488T','G0447','G0449','1030F','90719','G0296',
'90705','90708','90644','90389','90703','90704','90705','90706'),'Yes','No')) as Preventive_flag_Yr
FROM hap_ddr_raw.zz_obj_MSK_CB_Cohort_Label_HJ c
LEFT JOIN hap_ddr_raw.compass_claims_rollup_2021 a
ON a.partneremployerid = c.partneremployerid
AND a.patient_key = c.patient_key
LEFT JOIN edh_analytic_solutions_db.compass_claims_raw_cpt_hcpcs_procedure b
ON a.cpt_hcpcs_procedure_key = b.cpt_hcpcs_procedure_key 
GROUP BY 1,2,3,4
)
#########################################################################################################

Create table hap_ddr_raw.zz_part2_f21_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21
,MAX(if(b.diagnosis_code in (
'311','1530','1531','1532','1533','1534','1535','1536','1537','1538','1539',
'1560','1561','1562','1568','1569','1740','1741','1742','1743','1744','1745',
'1746','1748','1749','1750','1759','2720','2721','2722','2723','2724','2725',
'2726','2727','2728','2729','2772','2781','2782','2783','2784','2788','4010',
'4011','4019','4142','4143','4148','4280','4281','4289','4292','5734','5738',
'5739','5750','5752','5753','5754','5755','5756','5758','5759','5851','5852',
'5853','5854','5855','5856','5859','25000','25001','25002','25003','25010',
'25011','25012','25013','25020','25021','25022','25023','25030','25031','25032',
'25033','25040','25041','25042','25043','25050','25051','25052','25053','25060',
'25061','25062','25063','25070','25071','25072','25073','25080','25081','25082',
'25083','25090','25091','25092','25093','27800','27801','27802','27803','41400',
'41401','41402','41403','41404','41405','41406','41407','42820','42821','42822',
'42823','42830','42831','42832','42833','42840','42841','42842','42843','43301',
'43311','43320','43321','43331','43381','43391','43401','43411','43491','57510',
'57511','57512','71500','71504','71509','71510','71511','71512','71513','71514',
'71515','71516','71517','71518','71520','71521','71522','71523','71524','71525',
'71526','71527','71528','71530','71531','71532','71533','71534','71535','71536',
'71537','71538','71580','71589','71590','71591','71592','71593','71594','71595',
'71596','71597','71598','78050','78051','78052','78053','78054','78055','78056',
'78057','78059'),'Yes','No')) as Comorbidity_flag_Yr
FROM hap_ddr_raw.zz_obj_MSK_CB_Cohort_Label_HJ c
LEFT JOIN hap_ddr_raw.compass_claims_rollup_2021 a
ON a.partneremployerid = c.partneremployerid
AND a.patient_key = c.patient_key
LEFT JOIN edh_analytic_solutions_db.compass_claims_raw_diagnosis b
ON a.diagnosis_key = b.diagnosis_key
GROUP BY 1,2,3,4
)
#########################################################################################################

Create table hap_ddr_raw.zz_part3_f21_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21 
,MAX(if(b.diagnosis_code in (
'140','141','142','143','144','145','146','147','148','149','150','151','152','153','154','155',
'156','157','158','159','160','161','162','163','164','165','170','171','172','173','174','175',
'179','180','181','182','183','184','185','186','187','188','189','190','191','192', '193','194',
'195','199','390','393','412','430','431','436','449','452','1400','1401','1403','1404','1405',
'1406','1408','1409','1410','1411','1412','1413','1414','1415','1416','1418','1419','1420','1421','1422',
'1428','1429','1430','1431','1438','1439','1440','1441','1448','1449','1450','1451','1452','1453','1454',
'1455','1456','1458','1459','1460','1461','1462','1463','1464','1465','1466','1467','1468','1469','1470',
'1471','1472','1473','1478','1479','1480','1481','1482','1483','1488','1489','1490','1491','1498','1499',
'1500','1501','1502','1503','1504','1505','1508','1509','1510','1511','1512','1513','1514','1515','1516',
'1518','1519','1520','1521','1522','1523','1528','1529','1530','1531','1532','1533','1534','1535','1536',
'1537','1538','1539','1540','1541','1542','1543','1548','1550','1551','1560','1561','1562','1568','1569',
'1570','1571','1572','1573','1574','1578','1579','1580','1588','1589','1590','1591','1598','1599','1600',
'1601','1602','1603','1604','1605','1608','1609','1610','1611','1612','1613','1618','1619','1620','1622',
'1623','1624','1625','1628','1629','1630','1631','1638','1639','1640','1641','1642','1643','1648','1649',
'1650','1658','1659','1700','1701','1702','1703','1704','1705','1706','1710','1712','1713','1714','1715',
'1716','1717','1718','1719','1730','1731','1732','1733','1734','1735','1736','1737','1738','1739','1740',
'1741','1742','1743','1744','1745','1746','1748','1749','1750','1759','1800','1801','1808','1809','1820',
'1821','1828','1830','1832','1833','1834','1835','1838','1839','1840','1841','1842','1843','1844','1848',
'1849','1860','1869','1871','1872','1873','1874','1875','1876','1877','1878','1879','1880','1881','1882',
'1883','1884','1885','1886','1887','1888','1889','1890','1891','1892','1893','1894','1898','1899','1900',
'1901','1902','1903','1904','1905','1906','1907','1908','1909','1910','1911','1912','1913','1914','1915',
'1916','1917','1918','1919','1920','1921','1922','1923','1928','1929','1940','1941','1943','1944','1945',
'1946','1948','1949','1950','1951','1952','1953','1954','1955','1958','1990','1991','1992','2001','2002',
'2003','2004','2005','2006','2007','2008','2011','2012','2014','2015','2016','2017','2019','2021','2022',
'2023','2024','2025','2026','2027','2028','2029','2031','2038','2041','2042','2048','2049','2051','2052',
'2053','2058','2059','2061','2062','2068','2069','2071','2072','2078','2081','2082','2088','2089','2091',
'2092','2093','2332','2377','2384','2781','2782','2783','2784','2788','3910','3911','3912','3918','3919',
'3920','3929','3940','3941','3942','3949','3950','3951','3952','3959','3960','3961','3962','3963','3968',
'3969','3970','3971','3979','3980','4010','4011','4019','4110','4111','4130','4131','4139','4142','4143',
'4144','4148','4149','4150','4160','4161','4162','4168','4169','4170','4171','4178','4179','4200','4210',
'4211','4219','4220','4230','4231','4232','4233','4238','4239','4240','4241','4242','4243','4250','4252',
'4253','4254','4255','4257','4258','4259','4260','4262','4263','4264','4266','4267','4269','4270','4271',
'4272','4275','4279','4280','4281','4289','4290','4291','4292','4293','4294','4295','4296','4299','4320',
'4321','4329','4350','4351','4352','4353','4358','4359','4370','4371','4372','4373','4374','4375','4376',
'4377','4378','4379','4380','4386','4387','4389','4400','4401','4404','4408','4409','4411','4412','4413',
'4414','4415','4416','4417','4419','4420','4421','4422','4423','4429','4430','4431','4439','4441','4449',
'4460','4461','4463','4464','4465','4466','4467','4470','4471','4472','4473','4474','4475','4476','4478',
'4479','4480','4481','4489','4510','4512','4519','4530','4531','4532','4533','4536','4539','4540','4541',
'4542','4548','4549','4550','4551','4552','4553','4554','4555','4556','4557','4558','4559','4560','4561',
'4563','4564','4565','4566','4568','4570','4571','4572','4578','4579','4580','4581','4588','4589','4590',
'4592','4599','7140','7141','7142','7144','7149','7200','7201','7202','7209','20000','20001','20002','20003','20004','20005',
'20006','20007','20008','20010','20011','20012','20013','20014','20015','20016','20017','20018','20020','20021',
'20022','20023','20024','20025','20026','20027','20028','20030','20031','20032','20033','20034','20035','20036',
'20037','20038','20040','20041','20042','20043','20044','20045','20046','20047','20048','20050','20051','20052',
'20053','20054','20055','20056','20057','20058','20060','20061','20062','20063','20064','20065','20066','20067',
'20068','20070','20071','20072','20073','20074','20075','20076','20077','20078','20080','20081','20082','20083',
'20084','20085','20086','20087','20088','20100','20101','20102','20103','20104','20105','20106','20107','20108',
'20110','20111','20112','20113','20114','20115','20116','20117','20118','20120','20121','20122','20123','20124',
'20125','20126','20127','20128','20140','20141','20142','20143','20144','20145','20146','20147','20148','20150',
'20151','20152','20153','20154','20155','20156','20157','20158','20160','20161','20162','20163','20164','20165',
'20166','20167','20168','20170','20171','20172','20173','20174','20175','20176','20177','20178','20190','20191',
'20192','20193','20194','20195','20196','20197','20198','20200','20201','20202','20203','20204','20205','20206',
'20207','20208','20210','20211','20212','20213','20214','20215','20216','20217','20218','20220','20221','20222',
'20223','20224','20225','20226','20227','20228','20230','20231','20232','20233','20234','20235','20236','20237',
'20238','20240','20241','20242','20243','20244','20245','20246','20247','20248','20250','20251','20252','20253',
'20254','20255','20256','20257','20258','20260','20261','20262','20263','20264','20265','20266','20267','20268',
'20270','20271','20272','20273','20274','20275','20276','20277','20278','20280','20281','20282','20283','20284',
'20285','20286','20287','20288','20290','20291','20292','20293','20294','20295','20296','20297','20298','20300',
'20302','20310','20312','20380','20382','20400','20402','20410','20412','20420','20422','20480','20482','20490',
'20492','20500','20502','20510','20512','20520','20522','20530','20532','20580','20582','20590','20592','20600',
'20602','20610','20612','20620','20622','20680','20682','20690','20692','20700','20702','20710','20712','20720',
'20722','20780','20782','20800','20802','20810','20812','20820','20822','20880','20882','20890','20892','20900',
'20901','20902','20903','20910','20911','20912','20913','20914','20915','20916','20917','20920','20921','20922',
'20923','20924','20925','20926','20927','20929','20930','20931','20932','20933','20934','20935','20936','23770',
'23771','23772','23773','23779','23871','23872','23873','23874','23875','23876','23877','23879','25000','25001',
'25002','25003','25010','25011','25012','25013','25020','25021','25022','25023','25030','25031','25032','25033',
'25040','25041','25042','25043','25050','25051','25052','25053','25060','25061','25062','25063','25070','25071',
'25072','25073','25080','25081','25082','25083','25090','25091','25092','25093','27800','27801','27802','27803',
'39890','39891','39899','40200','40201','40210','40211','40290','40291','40300','40301','40310','40311','40390',
'40391','40400','40401','40402','40403','40410','40411','40412','40413','40490','40491','40492','40493','40501',
'40509','40511','40519','40591','40599','41000','41001','41002','41010','41011','41012','41020','41021','41022',
'41030','41031','41032','41040','41041','41042','41050','41051','41052','41060','41061','41062','41070','41071',
'41072','41080','41081','41082','41090','41091','41092','41181','41189','41400','41401','41402','41403','41404',
'41405','41406','41407','41410','41411','41412','41419','41511','41512','41513','41519','42090','42091','42099',
'42290','42291','42292','42293','42299','42490','42491','42499','42511','42518','42610','42611','42612','42613',
'42650','42651','42652','42653','42654','42681','42682','42689','42731','42732','42741','42742','42760','42761',
'42769','42781','42789','42820','42821','42822','42823','42830','42831','42832','42833','42840','42841','42842',
'42843','42971','42979','42981','42982','42983','42989','43300','43301','43310','43311','43320','43321','43330',
'43331','43380','43381','43390','43391','43400','43401','43410','43411','43490','43491','43810','43811','43812',
'43813','43814','43819','43820','43821','43822','43830','43831','43832','43840','43841','43842','43850','43851',
'43852','43853','43881','43882','43883','43884','43885','43889','44020','44021','44022','44023','44024','44029',
'44030','44031','44032','44100','44101','44102','44103','44281','44282','44283','44284','44289','44321','44322',
'44323','44324','44329','44381','44382','44389','44401','44409','44421','44422','44481','44489','44501','44502',
'44581','44589','44620','44621','44629','44770','44771','44772','44773','45111','45119','45181','45182','45183',
'45184','45189','45340','45341','45342','45350','45351','45352','45371','45372','45373','45374','45375','45376',
'45377','45379','45381','45382','45383','45384','45385','45386','45387','45389','45620','45621','45821','45829',
'45910','45911','45912','45913','45919','45930','45931','45932','45933','45939','45981','45989','71430','71431',
'71432','71433','71481','71489','73741','73742','73743','V1004','V1009','V1042', 'V1043','V1046', 'V1051','V1052','V1053',
'V1059', 'V1082','V1083','V1084','V1085','V1086','V1091','V1272','V151','V160','V161','V163','V1640','V1641','V1642',
'V1649','V1651','V1652','V1659','V166','V167','V168','V1811','V1819','V1851','V189','V421','V422','V4321','V4322','V433',
'V434','V4500','V4501', 'V4502', 'V4509', 'V4581','V4582','V4588','V472','V524','V5331','V5332', 'V5339','V581', 'V5861',
'V5863', 'V5866','V5873', 'V5881','V5882','V672','V711'),'Yes','No')) as Chronic_flag_Yr 
FROM hap_ddr_raw.zz_obj_MSK_CB_Cohort_Label_HJ c
LEFT JOIN hap_ddr_raw.compass_claims_rollup_2021 a
ON a.partneremployerid = c.partneremployerid
AND a.patient_key = c.patient_key
LEFT JOIN edh_analytic_solutions_db.compass_claims_raw_diagnosis b
ON a.diagnosis_key = b.diagnosis_key
GROUP BY 1,2,3,4
)


Create table hap_ddr_raw.zz_part4_f21_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21  
,MAX(if( b.diagnosis_key in (4,5,6,71,90,91,92,93,94,95,96,97,98,101,102,103,104,107,108,109,110,111,112,113,114,116,117,118,120,121,122,123,124,125,
127,128,129,131,132,137,138,140,143,146,148,149,152,153,157,158,164,165,166,167,170,177,179,180,181,185,187,189,191,192,1147,1180,1189,1190,4168,4174,
4226,4227,4233,4236,4238,4240,4242,4244,4245,4254,4258,4261,4262,4263,4264,4268,4269,4271,4272,4273,4274,4300,5488,5492,5720,5721,5722,5725,5726,5727,
5728,5734,5735,5738,5739,5744,5751,5757,5759,5770,5771,5774,5776,5782,5783,5784,5785,5786,5792,5810,5811,5812,5825,5827,5831,5844,6776,6804,6846,6849,
6850,7034,7239,7240,7241,7261,7286,7315,7319,7572,7573,7583,7587,7588,7589,7593,7595,7599,7600,7611,7616,7625,7639,7647,7649,7651,7653,7654,8193,8213,
8214,8229,8235,8236,8238,8255,8256,8263,8264,8267,8269,8275,8276,8277,8279,8285,8286,8289,8293,8309,8310,9049,9050,9051,9052,9053,9054,9055,9057,9058,
9061,9062,9099,9100,9101,10234,10239,10242,11120,11126,11129,11130,11132,11133,11135,11136,11138,11141,11142,11143,11144,11145,11146,11147,11148,11149,
11152,11153,11154,11155,11156,11157,11159,11160,11161,11162,11164,11165,11166,11168,11169,11170,11172,11174,11175,11176,11177,11178,11179,11180,11181,
11182,11185,11187,11189,11331,11471,11472,11474,11504,11513,11515,11518,11532,11534,11537,11543,11547,11549,11551,11561,11566,11569,11577,11578,11579,
11580,11584,11585,11586,11618,11625,11639,11642,11643,11645,11651,11652,11653,11654,11655,11656,11657,11658,11659,11661,11662,11663,11667,11671,11675,
11676,11677,11678,11679,11681,11683,12338,12348,12365,12416,12418,12419,12430,13054,14578,14579,14616,14618,14621,14626,14633,14637,14642,14656,14666,
14667,14668,14669,14672,14681,14683,14697,14698,14704,14707,14708,14711,14713,14714,14720,14723,14725,14727,14756,14757,14758,14759,14760,14763,14764,
14765,14766,14767,14768,14769,14770,14773,14774,14775,14776,14777,14783,14786,14790,14798,14800,14804,15256,15262,15271,15272,15273,15280,15281,15538,
15544,15554,15560,15564,15592,16740,16745,16747,16757
) AND 
b.diagnosis_code in 
("8485","8488","8489","7261","7260","72610","72611","72612","72619","7262","72630","72631","72632","7264","7265","72660","72661","72664","72665","72669",
"72670","72671","72672","72673","72679","72690","72691","72700","72703","72704","72705","72706","72709","7271","7273","72740","72741","72743","72749",
"72761","72762","72764","72767","72781","72783","72789","7291","7292","7294","7295","72981","72982","72989","72990","72999","7282","7284","7285","72871",
"72883","72885","72887","72889","7289","9551","9578","9532","9533","71611","71617","71690","71691","71697","71500","71509","71511","71513","71515","71516",
"71526","71531","71534","71535","71536","71537","71590","71591","71593","71594","71595","71596","7104","9593","9597","83900","83901","83902","83905","83906",
"83907","83908","83915","83916","83920","83921","83942","83969","83301","83303","83100","83101","83104","83110","8360","8361","8362","8363","8364","83659",
"83801","83802","83803","83400","83402","83200","8370","82300","82301","82332","82380","82381","82382","8220","82100","82120","82121","82520","82525","8260",
"82022","8242","8244","8246","8248","8249","8171","81305","81306","81323","81341","81342","81344","81600","81601","81500","81501","81504","81510","81200",
"81201","81202","81209","81220","81221","81240","81244","81400","81401","7230","7231","7232","7233","7234","7235","7236","7238","7239","72402","72403","7200",
"7201","7202","9052","9057","9070","840","8451","84200","84201","84209","84210","84212","84213","8400","8403","8404","8405","8406","8407","8408","8409","8460",
"8461","8468","8469","8470","8471","8472","8473","8479","8440","8441","8442","8448","8449","8430","8438","8439","8410","8412","8418","8419","84500","84501",
"84502","84503","84509","84510","84511","84519","8481","8483","9950","73740","73741","73743","73302","73316","73320","73329","73390","73392","73395","73810",
"7382","7384","7386","73606","73621","73630","73670","73671","73672","73673","73679","73681","73689","73030","73037","7321","7324","7325","7327","7390","7391",
"7392","7393","7394","7395","7396","7397","7398","734","7370","73710","73720","73730","73734","73739","7378","7379","7350","7352","7354","8760","8950","8910",
"8822","8831","8832","8841","94400","7194","7195","7140","7142","71432","7149","71807","71811","71817","71831","71841","71842","71843","71844","71847","71856",
"71858","71880","71881","71887","71890","71891","71894","71897","71898","71904","71907","71909","71911","71940","71941","71942","71943","71944","71947","71948",
"71949","71950","71951","71952","71953","71954","71957","71958","71959","71960","71961","71967","7197","71983","71991","71993","71997","92300","92311","92231",
"92232","92233","92411","92420","99851","99883","9962","99642","99646","99677","85400","85405","85409","85011"),'Yes','No')) as Diagnosis_flag_Yr
FROM hap_ddr_raw.zz_obj_MSK_CB_Cohort_Label_HJ c
LEFT JOIN hap_ddr_raw.compass_claims_rollup_2021 a
ON a.partneremployerid = c.partneremployerid
AND a.patient_key = c.patient_key
LEFT JOIN edh_analytic_solutions_db.compass_claims_raw_diagnosis b
ON a.diagnosis_key = b.diagnosis_key
GROUP BY 1,2,3,4
)

create table hap_ddr_raw.zz_part5_f21_HJ 
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21  
,MAX(if(b.cpt_hcpcs_procedure_key in (8728,8729,9370,9372,9373,9374,9375,9376,9377,9378,
9379,9380,9381,9382,9385,9386,9387,9388,9389,9391,9392,9393,9399,9400,9415,9416,9417,9418,
11920,15297,15298,19142,20139)
AND b.cpt_hcpcs_procedure_code in ("90901","90911","97010","97014","97016","97018","97022",
"97024","97026","97028","97032","97033","97034","97035","97110","97112","97113","97116","97124",
"97140","97150","97530","97545","97546","97810","97811","97813","97814","G0129","S8950","S8990",
"S8930","PTBUN"),'Yes','No')) as Procedure_flag_Yr
FROM hap_ddr_raw.zz_obj_MSK_CB_Cohort_Label_HJ c
LEFT JOIN hap_ddr_raw.compass_claims_rollup_2021 a
ON a.partneremployerid = c.partneremployerid
AND a.patient_key = c.patient_key
LEFT JOIN edh_analytic_solutions_db.compass_claims_raw_cpt_hcpcs_procedure b
ON a.cpt_hcpcs_procedure_key = b.cpt_hcpcs_procedure_key 
GROUP BY 1,2,3,4
)

############################################################################################################################
*Stiching together Yr, Yr_0 & Yr_1 costs tables
############################################################################################################################
create table hap_ddr_raw.zz_eda_part1_final_costYr_Yr_0Yr_1_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21  
,ISNULL(a.HS_flag_Yr_0,'NA') as HS_flag_Yr_0
,ISNULL(a.MH_flag_Yr_0,'NA') as MH_flag_Yr_0
,ISNULL(a.MSK_CKHBSurgery_flag_Yr_0,'NA') as MSK_CKHBSurgery_flag_Yr_0
,ISNULL(a.MSK_CKHNoSurgery_flag_Yr_0,'NA') as MSK_CKHNoSurgery_flag_Yr_0
,ISNULL(a.MSK_CBNoSurgery_flag_Yr_0,'NA') as MSK_CBNoSurgery_flag_Yr_0
,ISNULL(a.tot_billed_amt_Yr_0,0) as tot_billed_amt_Yr_0
,ISNULL(a.avg_billed_amt_Yr_0,0) as avg_billed_amt_Yr_0
,ISNULL(a.std_billed_amt_Yr_0,0) as std_billed_amt_Yr_0
,ISNULL(a.max_billed_amt_Yr_0,0) as max_billed_amt_Yr_0
,ISNULL(a.employer_paid_Yr_0,0) as employer_paid_Yr_0
,ISNULL(a.employee_paid1_Yr_0,0) as employee_paid1_Yr_0
,ISNULL(a.employee_paid2_Yr_0,0) as employee_paid2_Yr_0
,ISNULL(a.paid_thr_deduct_Yr_0,0) as paid_thr_deduct_Yr_0
,ISNULL(b.HS_flag_Yr_1,'NA') as HS_flag_Yr_1
,ISNULL(b.MH_flag_Yr_1,'NA') as MH_flag_Yr_1
,ISNULL(b.MSK_CKHBSurgery_flag_Yr_1,'NA') as MSK_CKHBSurgery_flag_Yr_1
,ISNULL(b.MSK_CKHNoSurgery_flag_Yr_1,'NA') as MSK_CKHNoSurgery_flag_Yr_1
,ISNULL(b.MSK_CBNoSurgery_flag_Yr_1,'NA') as MSK_CBNoSurgery_flag_Yr_1
,ISNULL(b.tot_billed_amt_Yr_1,0) as tot_billed_amt_Yr_1
,ISNULL(b.avg_billed_amt_Yr_1,0) as avg_billed_amt_Yr_1
,ISNULL(b.std_billed_amt_Yr_1,0) as std_billed_amt_Yr_1
,ISNULL(b.max_billed_amt_Yr_1,0) as max_billed_amt_Yr_1
,ISNULL(b.employer_paid_Yr_1,0) as employer_paid_Yr_1
,ISNULL(b.employee_paid1_Yr_1,0) as employee_paid1_Yr_1
,ISNULL(b.employee_paid2_Yr_1,0) as employee_paid2_Yr_1
,ISNULL(b.paid_thr_deduct_Yr_1,0) as paid_thr_deduct_Yr_1
,ISNULL(d.HS_flag_Yr,'NA') as HS_flag_Yr
,ISNULL(d.MH_flag_Yr,'NA') as MH_flag_Yr
,ISNULL(d.MSK_CKHBSurgery_flag_Yr,'NA') as MSK_CKHBSurgery_flag_Yr
,ISNULL(d.MSK_CKHNoSurgery_flag_Yr,'NA') as MSK_CKHNoSurgery_flag_Yr
,ISNULL(d.MSK_CBNoSurgery_flag_Yr,'NA') as MSK_CBNoSurgery_flag_Yr
,ISNULL(d.tot_billed_amt_Yr,0) as tot_billed_amt_Yr
,ISNULL(d.avg_billed_amt_Yr,0) as avg_billed_amt_Yr
,ISNULL(d.std_billed_amt_Yr,0) as std_billed_amt_Yr
,ISNULL(d.max_billed_amt_Yr,0) as max_billed_amt_Yr
,ISNULL(d.employer_paid_Yr,0) as employer_paid_Yr
,ISNULL(d.employee_paid1_Yr,0) as employee_paid1_Yr
,ISNULL(d.employee_paid2_Yr,0) as employee_paid2_Yr
,ISNULL(d.paid_thr_deduct_Yr,0) as paid_thr_deduct_Yr
FROM hap_ddr_raw.zz_obj_MSK_CB_Cohort_Label_HJ c
JOIN hap_ddr_raw.zz_obj_CB_partcost20_HJ a
ON a.person_internal_id = c.person_internal_id
AND a.partneremployerid = c.partneremployerid
AND a.patient_key = c.patient_key
JOIN hap_ddr_raw.zz_obj_CB_partcost19_HJ b
ON b.person_internal_id = c.person_internal_id
AND b.partneremployerid = c.partneremployerid
AND b.patient_key = c.patient_key
JOIN hap_ddr_raw.zz_obj_CB_partcost21_HJ d
ON d.person_internal_id = c.person_internal_id
AND d.partneremployerid = c.partneremployerid
AND d.patient_key = c.patient_key
)

drop table hap_ddr_raw.zz_obj_CB_partcost21_HJ 
drop table hap_ddr_raw.zz_obj_CB_partcost20_HJ 
drop table hap_ddr_raw.zz_obj_CB_partcost19_HJ 

################################################################################################
*Stiching together health flags tables Yr_0
################################################################################################

Create table hap_ddr_raw.zz_eda_Yr_0_health_flags_HJ 
AS (
SELECT  c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21 
,a.Preventive_flag_Yr_0
,b.comorbidity_flag_Yr_0
,d.chronic_flag_Yr_0
,e.Diagnosis_flag_Yr_0
,f.Procedure_flag_Yr_0
FROM hap_ddr_raw.zz_obj_MSK_CB_Cohort_Label_HJ c
JOIN hap_ddr_raw.zz_part1_f20_HJ a
ON a.person_internal_id = c.person_internal_id
AND a.partneremployerid = c.partneremployerid
AND a.patient_key = c.patient_key
JOIN hap_ddr_raw.zz_part2_f20_HJ b
ON b.person_internal_id = c.person_internal_id
AND b.partneremployerid = c.partneremployerid
AND b.patient_key = c.patient_key
JOIN hap_ddr_raw.zz_part3_f20_HJ d
ON d.person_internal_id = c.person_internal_id
AND d.partneremployerid = c.partneremployerid
AND d.patient_key = c.patient_key
JOIN hap_ddr_raw.zz_part4_f20_HJ e
ON e.person_internal_id = c.person_internal_id
AND e.partneremployerid = c.partneremployerid
AND e.patient_key = c.patient_key
JOIN hap_ddr_raw.zz_part5_f20_HJ f
ON f.person_internal_id = c.person_internal_id
AND f.partneremployerid = c.partneremployerid
AND f.patient_key = c.patient_key
)

drop table hap_ddr_raw.zz_part1_f20_HJ
drop table hap_ddr_raw.zz_part2_f20_HJ
drop table hap_ddr_raw.zz_part3_f20_HJ
drop table hap_ddr_raw.zz_part4_f20_HJ
drop table hap_ddr_raw.zz_part5_f20_HJ

#################################################################################################
*Stiching together health flags tables Yr_1
#################################################################################################

Create table hap_ddr_raw.zz_eda_Yr_1_health_flags_HJ 
AS (
SELECT  c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21 
,a.Preventive_flag_Yr_1
,b.comorbidity_flag_Yr_1
,d.chronic_flag_Yr_1
,e.Diagnosis_flag_Yr_1
,f.Procedure_flag_Yr_1
FROM hap_ddr_raw.zz_obj_MSK_CB_Cohort_Label_HJ c
JOIN hap_ddr_raw.zz_part1_f19_HJ a
ON a.person_internal_id = c.person_internal_id
AND a.partneremployerid = c.partneremployerid
AND a.patient_key = c.patient_key
JOIN hap_ddr_raw.zz_part2_f19_HJ b
ON b.person_internal_id = c.person_internal_id
AND b.partneremployerid = c.partneremployerid
AND b.patient_key = c.patient_key
JOIN hap_ddr_raw.zz_part3_f19_HJ d
ON d.person_internal_id = c.person_internal_id
AND d.partneremployerid = c.partneremployerid
AND d.patient_key = c.patient_key
JOIN hap_ddr_raw.zz_part4_f19_HJ e
ON e.person_internal_id = c.person_internal_id
AND e.partneremployerid = c.partneremployerid
AND e.patient_key = c.patient_key
JOIN hap_ddr_raw.zz_part5_f19_HJ f
ON f.person_internal_id = c.person_internal_id
AND f.partneremployerid = c.partneremployerid
AND f.patient_key = c.patient_key
)

drop table hap_ddr_raw.zz_part1_f19_HJ
drop table hap_ddr_raw.zz_part2_f19_HJ
drop table hap_ddr_raw.zz_part3_f19_HJ
drop table hap_ddr_raw.zz_part4_f19_HJ
drop table hap_ddr_raw.zz_part5_f19_HJ


#################################################################################################
*Stiching together health flags tables Yr
#################################################################################################

Create table hap_ddr_raw.zz_eda_Yr_health_flags_HJ 
AS (
SELECT  c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21 
,a.Preventive_flag_Yr
,b.comorbidity_flag_Yr
,d.chronic_flag_Yr
,e.Diagnosis_flag_Yr
,f.Procedure_flag_Yr
FROM hap_ddr_raw.zz_obj_MSK_CB_Cohort_Label_HJ c
JOIN hap_ddr_raw.zz_part1_f21_HJ a
ON a.person_internal_id = c.person_internal_id
AND a.partneremployerid = c.partneremployerid
AND a.patient_key = c.patient_key
JOIN hap_ddr_raw.zz_part2_f21_HJ b
ON b.person_internal_id = c.person_internal_id
AND b.partneremployerid = c.partneremployerid
AND b.patient_key = c.patient_key
JOIN hap_ddr_raw.zz_part3_f21_HJ d
ON d.person_internal_id = c.person_internal_id
AND d.partneremployerid = c.partneremployerid
AND d.patient_key = c.patient_key
JOIN hap_ddr_raw.zz_part4_f21_HJ e
ON e.person_internal_id = c.person_internal_id
AND e.partneremployerid = c.partneremployerid
AND e.patient_key = c.patient_key
JOIN hap_ddr_raw.zz_part5_f21_HJ f
ON f.person_internal_id = c.person_internal_id
AND f.partneremployerid = c.partneremployerid
AND f.patient_key = c.patient_key
)

drop table hap_ddr_raw.zz_part1_f21_HJ
drop table hap_ddr_raw.zz_part2_f21_HJ
drop table hap_ddr_raw.zz_part3_f21_HJ
drop table hap_ddr_raw.zz_part4_f21_HJ
drop table hap_ddr_raw.zz_part5_f21_HJ

##############################################################################################################
*Stiching together health flags tables Yr, Yr_0 & Yr_1
##############################################################################################################
Create table hap_ddr_raw.zz_eda_Yr_Yr_0_Yr_1_health_flags_HJ
AS (
SELECT a.person_internal_id
,a.partneremployerid
,a.patient_key
,a.MSK_CBNoSurgery_flag_Obj21 
,a.Preventive_flag_Yr_0
,a.comorbidity_flag_Yr_0
,a.chronic_flag_Yr_0
,a.Diagnosis_flag_Yr_0
,a.Procedure_flag_Yr_0
,b.Preventive_flag_Yr_1
,b.comorbidity_flag_Yr_1
,b.chronic_flag_Yr_1
,b.Diagnosis_flag_Yr_1
,b.Procedure_flag_Yr_1
,c.Preventive_flag_Yr
,c.comorbidity_flag_Yr
,c.chronic_flag_Yr
,c.Diagnosis_flag_Yr
,c.Procedure_flag_Yr
FROM hap_ddr_raw.zz_eda_Yr_0_health_flags_HJ a
JOIN hap_ddr_raw.zz_eda_Yr_1_health_flags_HJ b
ON a.person_internal_id = b.person_internal_id
AND a.partneremployerid = b.partneremployerid
AND a.patient_key = b.patient_key
JOIN hap_ddr_raw.zz_eda_Yr_health_flags_HJ c
ON c.person_internal_id = b.person_internal_id
AND c.partneremployerid = b.partneremployerid
AND c.patient_key = b.patient_key
)

drop table hap_ddr_raw.zz_eda_Yr_0_health_flags_HJ
drop table hap_ddr_raw.zz_eda_Yr_1_health_flags_HJ 
drop table hap_ddr_raw.zz_eda_Yr_health_flags_HJ
##############################################################################################################
****Flags for Transpose*******
Count = 5006878 rows

Create table hap_ddr_raw.zz_eda_part4_visit_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21  
,b.proc_category_description
,COUNT(c.patient_key) as counter
FROM hap_ddr_raw.zz_obj_MSK_CB_Cohort_Label_HJ c
JOIN  hap_ddr_raw.compass_claims_rollup_2021 a
ON c.partneremployerid = a.partneremployerid
AND c.patient_key = a.patient_key 
JOIN edh_analytic_solutions_db.compass_claims_raw_procedure_category b
ON a.proc_category_code = b.proc_category_code
GROUP BY 1,2,3,4,5
);


Create table hap_ddr_raw.zz_eda_part4_visit_y1_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21  
,b.proc_category_description
,COUNT(c.patient_key) as counter
FROM hap_ddr_raw.zz_obj_MSK_CB_Cohort_Label_HJ c
JOIN  hap_ddr_raw.compass_claims_rollup_2019 a
ON c.partneremployerid = a.partneremployerid
AND c.patient_key = a.patient_key 
JOIN edh_analytic_solutions_db.compass_claims_raw_procedure_category b
ON a.proc_category_code = b.proc_category_code
GROUP BY 1,2,3,4,5
)
;

Create table hap_ddr_raw.zz_eda_part4_visit_y0_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21  
,b.proc_category_description
,COUNT(c.patient_key) as counter
FROM hap_ddr_raw.zz_obj_MSK_CB_Cohort_Label_HJ c
JOIN  hap_ddr_raw.compass_claims_rollup_2020 a
ON c.partneremployerid = a.partneremployerid
AND c.patient_key = a.patient_key 
JOIN edh_analytic_solutions_db.compass_claims_raw_procedure_category b
ON a.proc_category_code = b.proc_category_code
GROUP BY 1,2,3,4,5
);
##############################################################################################################
SELECT c.proc_category_description, count(*)
FROM hap_ddr_raw.zz_eda_part4_visit_HJ c
GROUP BY 1

proc_category_description	count(*)	
1	Global - Imaging	413498
2	Physician - Specialist	1054321
3	Facility - Imaging	50190
4	Physician - Primary Care	874760
5	Facility - Inpatient	77527
6	Physician - Imaging	144517
7	Physician	66599
8	Facility - Outpatient	581122
9	Unknown	782604
10	Durable Medical Equipment	90088
11	Lab	871652


SELECT c.proc_category_description, count(*)
FROM hap_ddr_raw.zz_eda_part4_visit_y1_HJ c
GROUP BY 1

1	Global - Imaging	256088
2	Physician - Specialist	622264
3	Facility - Imaging	32817
4	Physician - Primary Care	524397
5	Physician - Imaging	106519
6	Facility - Inpatient	49546
7	Physician	42825
8	Facility - Outpatient	336249
9	Unknown	84638
10	Durable Medical Equipment	58729
11	Lab	553661


SELECT c.proc_category_description, count(*)
FROM hap_ddr_raw.zz_eda_part4_visit_y0_HJ c
GROUP BY 1

1	Global - Imaging	314666
2	Physician - Specialist	820083
3	Facility - Imaging	40077
4	Physician - Imaging	120423
5	Physician - Primary Care	712885
6	Physician	50665
7	Facility - Inpatient	68825
8	Facility - Outpatient	440214
9	Unknown	417029
10	Durable Medical Equipment	78222
11	Lab	698193


############################################################################################################

Create table hap_ddr_raw.zz_eda_vist_p1_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21 
,counter as 'Global_imaging_vist'
FROM hap_ddr_raw.zz_eda_part4_visit_HJ c
WHERE proc_category_description = 'Global - Imaging'
)
;
Create table hap_ddr_raw.zz_eda_vist_p2_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21
,counter as 'Specialist_vist'
FROM hap_ddr_raw.zz_eda_part4_visit_HJ c
WHERE proc_category_description = 'Physician - Specialist'
)
;
Create table hap_ddr_raw.zz_eda_vist_p3_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21
,counter as 'Facility_imaging_vist'
FROM hap_ddr_raw.zz_eda_part4_visit_HJ c
WHERE proc_category_description = 'Facility - Imaging'
)

;
Create table hap_ddr_raw.zz_eda_vist_p4_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21 
,counter as 'Primary_care_vist'
FROM hap_ddr_raw.zz_eda_part4_visit_HJ c
WHERE proc_category_description = 'Physician - Primary Care'
)

;
Create table hap_ddr_raw.zz_eda_vist_p5_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21 
,counter as 'Physician_imaging_vist'
FROM hap_ddr_raw.zz_eda_part4_visit_HJ c
WHERE proc_category_description = 'Physician - Imaging'
)
;
Create table hap_ddr_raw.zz_eda_vist_p6_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21 
,counter as 'Inpatient_vist'
FROM hap_ddr_raw.zz_eda_part4_visit_HJ c
WHERE proc_category_description = 'Facility - Inpatient'
)
;
Create table hap_ddr_raw.zz_eda_vist_p7_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21 
,counter as 'Physician_vist'
FROM hap_ddr_raw.zz_eda_part4_visit_HJ c
WHERE proc_category_description = 'Physician'
)
;
Create table hap_ddr_raw.zz_eda_vist_p8_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21 
,counter as 'Outpatien_vist'
FROM hap_ddr_raw.zz_eda_part4_visit_HJ c
WHERE proc_category_description = 'Facility - Outpatient'
)
;
Create table hap_ddr_raw.zz_eda_vist_p9_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21 
,counter as 'Unknown_visit'
FROM hap_ddr_raw.zz_eda_part4_visit_HJ c
WHERE proc_category_description = 'Unknown'
)
;
Create table hap_ddr_raw.zz_eda_vist_p10_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21 
,counter as 'Durable_medical_visit'
FROM hap_ddr_raw.zz_eda_part4_visit_HJ c
WHERE proc_category_description = 'Durable Medical Equipment'
)
;
Create table hap_ddr_raw.zz_eda_vist_p11_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21 
,counter as 'Lab_visit'
FROM hap_ddr_raw.zz_eda_part4_visit_HJ c
WHERE proc_category_description = 'Lab'
)
;
Create table hap_ddr_raw.zz_eda_vist_p1_y0_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21 
,counter as 'Global_imaging_vist'
FROM hap_ddr_raw.zz_eda_part4_visit_y0_HJ c
WHERE proc_category_description = 'Global - Imaging'
)
;
Create table hap_ddr_raw.zz_eda_vist_p2_y0_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21 
,counter as 'Specialist_vist'
FROM hap_ddr_raw.zz_eda_part4_visit_y0_HJ c
WHERE proc_category_description = 'Physician - Specialist'
)
;
Create table hap_ddr_raw.zz_eda_vist_p3_y0_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21
,counter as 'Facility_imaging_vist'
FROM hap_ddr_raw.zz_eda_part4_visit_y0_HJ c
WHERE proc_category_description = 'Facility - Imaging'
)
;
Create table hap_ddr_raw.zz_eda_vist_p4_y0_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21 
,counter as 'Primary_care_vist'
FROM hap_ddr_raw.zz_eda_part4_visit_y0_HJ c
WHERE proc_category_description = 'Physician - Primary Care'
)
;
Create table hap_ddr_raw.zz_eda_vist_p5_y0_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21 
,counter as 'Physician_imaging_vist'
FROM hap_ddr_raw.zz_eda_part4_visit_y0_HJ c
WHERE proc_category_description = 'Physician - Imaging'
)
;
Create table hap_ddr_raw.zz_eda_vist_p6_y0_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21 
,counter as 'Inpatient_vist'
FROM hap_ddr_raw.zz_eda_part4_visit_y0_HJ c
WHERE proc_category_description = 'Facility - Inpatient'
)
;
Create table hap_ddr_raw.zz_eda_vist_p7_y0_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21
,counter as 'Physician_vist'
FROM hap_ddr_raw.zz_eda_part4_visit_y0_HJ c
WHERE proc_category_description = 'Physician'
)
;
Create table hap_ddr_raw.zz_eda_vist_p8_y0_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21
,counter as 'Outpatien_vist'
FROM hap_ddr_raw.zz_eda_part4_visit_y0_HJ c
WHERE proc_category_description = 'Facility - Outpatient'
)
;
Create table hap_ddr_raw.zz_eda_vist_p9_y0_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21 
,counter as 'Unknown_visit'
FROM hap_ddr_raw.zz_eda_part4_visit_y0_HJ c
WHERE proc_category_description = 'Unknown'
)
;
Create table hap_ddr_raw.zz_eda_vist_p10_y0_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21 
,counter as 'Durable_medical_visit'
FROM hap_ddr_raw.zz_eda_part4_visit_y0_HJ c
WHERE proc_category_description = 'Durable Medical Equipment'
)
;
Create table hap_ddr_raw.zz_eda_vist_p11_y0_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21
,counter as 'Lab_visit'
FROM hap_ddr_raw.zz_eda_part4_visit_y0_HJ c
WHERE proc_category_description = 'Lab'
)
;
Create table hap_ddr_raw.zz_eda_vist_p1_y1_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21
,counter as 'Global_imaging_vist'
FROM hap_ddr_raw.zz_eda_part4_visit_y1_HJ c
WHERE proc_category_description = 'Global - Imaging'
)
;
Create table hap_ddr_raw.zz_eda_vist_p2_y1_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21
,counter as 'Specialist_vist'
FROM hap_ddr_raw.zz_eda_part4_visit_y1_HJ c
WHERE proc_category_description = 'Physician - Specialist'
)
;
Create table hap_ddr_raw.zz_eda_vist_p3_y1_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21
,counter as 'Facility_imaging_vist'
FROM hap_ddr_raw.zz_eda_part4_visit_y1_HJ c
WHERE proc_category_description = 'Facility - Imaging'
)
;
Create table hap_ddr_raw.zz_eda_vist_p4_y1_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21
,counter as 'Primary_care_vist'
FROM hap_ddr_raw.zz_eda_part4_visit_y1_HJ c
WHERE proc_category_description = 'Physician - Primary Care'
)
;
Create table hap_ddr_raw.zz_eda_vist_p5_y1_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21
,counter as 'Physician_imaging_vist'
FROM hap_ddr_raw.zz_eda_part4_visit_y1_HJ c
WHERE proc_category_description = 'Physician - Imaging'
)
;
Create table hap_ddr_raw.zz_eda_vist_p6_y1_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21
,counter as 'Inpatient_vist'
FROM hap_ddr_raw.zz_eda_part4_visit_y1_HJ c
WHERE proc_category_description = 'Facility - Inpatient'
)
;
Create table hap_ddr_raw.zz_eda_vist_p7_y1_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21
,counter as 'Physician_vist'
FROM hap_ddr_raw.zz_eda_part4_visit_y1_HJ c
WHERE proc_category_description = 'Physician'
)
;
Create table hap_ddr_raw.zz_eda_vist_p8_y1_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21
,counter as 'Outpatien_vist'
FROM hap_ddr_raw.zz_eda_part4_visit_y1_HJ c
WHERE proc_category_description = 'Facility - Outpatient'
)
;
Create table hap_ddr_raw.zz_eda_vist_p9_y1_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21
,counter as 'Unknown_visit'
FROM hap_ddr_raw.zz_eda_part4_visit_y1_HJ c
WHERE proc_category_description = 'Unknown'
);

Create table hap_ddr_raw.zz_eda_vist_p10_y1_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21
,counter as 'Durable_medical_visit'
FROM hap_ddr_raw.zz_eda_part4_visit_y1_HJ c
WHERE proc_category_description = 'Durable Medical Equipment'
);

Create table hap_ddr_raw.zz_eda_vist_p11_y1_HJ
AS (
SELECT c.person_internal_id
,c.partneremployerid
,c.patient_key
,c.MSK_CBNoSurgery_flag_Obj21
,counter as 'Lab_visit'
FROM hap_ddr_raw.zz_eda_part4_visit_y1_HJ c
WHERE proc_category_description = 'Lab'
);


##################################################################################################
*Stiching together procedure category count tables
##################################################################################################
Create table hap_ddr_raw.zz_eda_part4_proc_cat_final_HJ
AS (
SELECT z.person_internal_id
,z.partneremployerid
,z.patient_key
,z.MSK_CBNoSurgery_flag_Obj21
,MAX(if(a.global_imaging_vist > 0,'Yes','No')) as global_imaging_ind
,MAX(if(b.specialist_vist > 0,'Yes','No')) as specialist_ind
,MAX(if(c.facility_imaging_vist > 0,'Yes','No')) as facility_imaging_ind
,MAX(if(d.primary_care_vist > 0,'Yes','No')) as primary_care_ind
,MAX(if(e.physician_imaging_vist > 0,'Yes','No')) as physician_imaging_ind
,MAX(if(f.inpatient_vist > 0,'Yes','No')) as inpatient_ind
,MAX(if(g.physician_vist > 0,'Yes','No')) as physician_ind
,MAX(if(h.outpatien_vist > 0,'Yes','No')) as outpatient_ind
,MAX(if(i.Unknown_visit > 0,'Yes','No')) as Unknown_ind
,MAX(if(j.durable_medical_visit > 0,'Yes','No')) as durable_medical_ind
,MAX(if(k.lab_visit > 0,'Yes','No')) as lab_visit_ind
from hap_ddr_raw.zz_eda_part4_visit_HJ z
LEFT JOIN hap_ddr_raw.zz_eda_vist_p1_HJ a
ON a.person_internal_id = z.person_internal_id
AND a.partneremployerid = z.partneremployerid
AND a.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_vist_p2_HJ b
ON b.person_internal_id = z.person_internal_id
AND b.partneremployerid = z.partneremployerid
AND b.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_vist_p3_HJ c
ON c.person_internal_id = z.person_internal_id
AND c.partneremployerid = z.partneremployerid
AND c.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_vist_p4_HJ d
ON d.person_internal_id = z.person_internal_id
AND d.partneremployerid = z.partneremployerid
AND d.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_vist_p5_HJ e
ON e.person_internal_id = z.person_internal_id
AND e.partneremployerid = z.partneremployerid
AND e.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_vist_p6_HJ f
ON f.person_internal_id = z.person_internal_id
AND f.partneremployerid = z.partneremployerid
AND f.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_vist_p7_HJ g
ON g.person_internal_id = z.person_internal_id
AND g.partneremployerid = z.partneremployerid
AND g.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_vist_p8_HJ h
ON h.person_internal_id = z.person_internal_id
AND h.partneremployerid = z.partneremployerid
AND h.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_vist_p9_HJ i
ON i.person_internal_id = z.person_internal_id
AND i.partneremployerid = z.partneremployerid
AND i.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_vist_p10_HJ j
ON j.person_internal_id = z.person_internal_id
AND j.partneremployerid = z.partneremployerid
AND j.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_vist_p11_HJ k
ON k.person_internal_id = z.person_internal_id
AND k.partneremployerid = z.partneremployerid
AND k.patient_key = z.patient_key
GROUP BY 1,2,3,4
)

drop table hap_ddr_raw.zz_eda_part4_visit_HJ
drop table hap_ddr_raw.zz_eda_vist_p1_HJ;
drop table hap_ddr_raw.zz_eda_vist_p2_HJ;
drop table hap_ddr_raw.zz_eda_vist_p3_HJ;
drop table hap_ddr_raw.zz_eda_vist_p4_HJ;
drop table hap_ddr_raw.zz_eda_vist_p5_HJ;
drop table hap_ddr_raw.zz_eda_vist_p6_HJ;
drop table hap_ddr_raw.zz_eda_vist_p7_HJ;
drop table hap_ddr_raw.zz_eda_vist_p8_HJ;
drop table hap_ddr_raw.zz_eda_vist_p9_HJ;
drop table hap_ddr_raw.zz_eda_vist_p10_HJ;
drop table hap_ddr_raw.zz_eda_vist_p11_HJ;



Create table hap_ddr_raw.zz_eda_part4_proc_cat_final_y1_HJ
AS (
SELECT z.person_internal_id
,z.partneremployerid
,z.patient_key
,z.MSK_CBNoSurgery_flag_Obj21
,MAX(if(a.global_imaging_vist > 0,'Yes','No')) as global_imaging_ind
,MAX(if(b.specialist_vist > 0,'Yes','No')) as specialist_ind
,MAX(if(c.facility_imaging_vist > 0,'Yes','No')) as facility_imaging_ind
,MAX(if(d.primary_care_vist > 0,'Yes','No')) as primary_care_ind
,MAX(if(e.physician_imaging_vist > 0,'Yes','No')) as physician_imaging_ind
,MAX(if(f.inpatient_vist > 0,'Yes','No')) as inpatient_ind
,MAX(if(g.physician_vist > 0,'Yes','No')) as physician_ind
,MAX(if(h.outpatien_vist > 0,'Yes','No')) as outpatient_ind
,MAX(if(i.Unknown_visit > 0,'Yes','No')) as Unknown_ind
,MAX(if(j.durable_medical_visit > 0,'Yes','No')) as durable_medical_ind
,MAX(if(k.lab_visit > 0,'Yes','No')) as lab_visit_ind
from hap_ddr_raw.zz_eda_part4_visit_y1_HJ z
LEFT JOIN hap_ddr_raw.zz_eda_vist_p1_y1_HJ a
ON a.person_internal_id = z.person_internal_id
AND a.partneremployerid = z.partneremployerid
AND a.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_vist_p2_y1_HJ b
ON b.person_internal_id = z.person_internal_id
AND b.partneremployerid = z.partneremployerid
AND b.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_vist_p3_y1_HJ c
ON c.person_internal_id = z.person_internal_id
AND c.partneremployerid = z.partneremployerid
AND c.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_vist_p4_y1_HJ d
ON d.person_internal_id = z.person_internal_id
AND d.partneremployerid = z.partneremployerid
AND d.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_vist_p5_y1_HJ e
ON e.person_internal_id = z.person_internal_id
AND e.partneremployerid = z.partneremployerid
AND e.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_vist_p6_y1_HJ f
ON f.person_internal_id = z.person_internal_id
AND f.partneremployerid = z.partneremployerid
AND f.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_vist_p7_y1_HJ g
ON g.person_internal_id = z.person_internal_id
AND g.partneremployerid = z.partneremployerid
AND g.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_vist_p8_y1_HJ h
ON h.person_internal_id = z.person_internal_id
AND h.partneremployerid = z.partneremployerid
AND h.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_vist_p9_y1_HJ i
ON i.person_internal_id = z.person_internal_id
AND i.partneremployerid = z.partneremployerid
AND i.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_vist_p10_y1_HJ j
ON j.person_internal_id = z.person_internal_id
AND j.partneremployerid = z.partneremployerid
AND j.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_vist_p11_y1_HJ k
ON k.person_internal_id = z.person_internal_id
AND k.partneremployerid = z.partneremployerid
AND k.patient_key = z.patient_key
GROUP BY 1,2,3,4
)



drop table hap_ddr_raw.zz_eda_part4_visit_y1_HJ
drop table hap_ddr_raw.zz_eda_vist_p1_y1_HJ;
drop table hap_ddr_raw.zz_eda_vist_p2_y1_HJ;
drop table hap_ddr_raw.zz_eda_vist_p3_y1_HJ;
drop table hap_ddr_raw.zz_eda_vist_p4_y1_HJ;
drop table hap_ddr_raw.zz_eda_vist_p5_y1_HJ;
drop table hap_ddr_raw.zz_eda_vist_p6_y1_HJ;
drop table hap_ddr_raw.zz_eda_vist_p7_y1_HJ;
drop table hap_ddr_raw.zz_eda_vist_p8_y1_HJ;
drop table hap_ddr_raw.zz_eda_vist_p9_y1_HJ;
drop table hap_ddr_raw.zz_eda_vist_p10_y1_HJ;
drop table hap_ddr_raw.zz_eda_vist_p11_y1_HJ;



Create table hap_ddr_raw.zz_eda_part4_proc_cat_final_y0_HJ
AS (
SELECT z.person_internal_id
,z.partneremployerid
,z.patient_key
,z.MSK_CBNoSurgery_flag_Obj21
,MAX(if(a.global_imaging_vist > 0,'Yes','No')) as global_imaging_ind
,MAX(if(b.specialist_vist > 0,'Yes','No')) as specialist_ind
,MAX(if(c.facility_imaging_vist > 0,'Yes','No')) as facility_imaging_ind
,MAX(if(d.primary_care_vist > 0,'Yes','No')) as primary_care_ind
,MAX(if(e.physician_imaging_vist > 0,'Yes','No')) as physician_imaging_ind
,MAX(if(f.inpatient_vist > 0,'Yes','No')) as inpatient_ind
,MAX(if(g.physician_vist > 0,'Yes','No')) as physician_ind
,MAX(if(h.outpatien_vist > 0,'Yes','No')) as outpatient_ind
,MAX(if(i.Unknown_visit > 0,'Yes','No')) as Unknown_ind
,MAX(if(j.durable_medical_visit > 0,'Yes','No')) as durable_medical_ind
,MAX(if(k.lab_visit > 0,'Yes','No')) as lab_visit_ind
from hap_ddr_raw.zz_eda_part4_visit_y0_HJ z
LEFT JOIN hap_ddr_raw.zz_eda_vist_p1_y0_HJ a
ON a.person_internal_id = z.person_internal_id
AND a.partneremployerid = z.partneremployerid
AND a.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_vist_p2_y0_HJ b
ON b.person_internal_id = z.person_internal_id
AND b.partneremployerid = z.partneremployerid
AND b.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_vist_p3_y0_HJ c
ON c.person_internal_id = z.person_internal_id
AND c.partneremployerid = z.partneremployerid
AND c.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_vist_p4_y0_HJ d
ON d.person_internal_id = z.person_internal_id
AND d.partneremployerid = z.partneremployerid
AND d.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_vist_p5_y0_HJ e
ON e.person_internal_id = z.person_internal_id
AND e.partneremployerid = z.partneremployerid
AND e.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_vist_p6_y0_HJ f
ON f.person_internal_id = z.person_internal_id
AND f.partneremployerid = z.partneremployerid
AND f.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_vist_p7_y0_HJ g
ON g.person_internal_id = z.person_internal_id
AND g.partneremployerid = z.partneremployerid
AND g.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_vist_p8_y0_HJ h
ON h.person_internal_id = z.person_internal_id
AND h.partneremployerid = z.partneremployerid
AND h.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_vist_p9_y0_HJ i
ON i.person_internal_id = z.person_internal_id
AND i.partneremployerid = z.partneremployerid
AND i.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_vist_p10_y0_HJ j
ON j.person_internal_id = z.person_internal_id
AND j.partneremployerid = z.partneremployerid
AND j.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_vist_p11_y0_HJ k
ON k.person_internal_id = z.person_internal_id
AND k.partneremployerid = z.partneremployerid
AND k.patient_key = z.patient_key
GROUP BY 1,2,3,4
)



drop table hap_ddr_raw.zz_eda_part4_visit_y0_HJ
drop table hap_ddr_raw.zz_eda_vist_p1_y0_HJ;
drop table hap_ddr_raw.zz_eda_vist_p2_y0_HJ;
drop table hap_ddr_raw.zz_eda_vist_p3_y0_HJ;
drop table hap_ddr_raw.zz_eda_vist_p4_y0_HJ;
drop table hap_ddr_raw.zz_eda_vist_p5_y0_HJ;
drop table hap_ddr_raw.zz_eda_vist_p6_y0_HJ;
drop table hap_ddr_raw.zz_eda_vist_p7_y0_HJ;
drop table hap_ddr_raw.zz_eda_vist_p8_y0_HJ;
drop table hap_ddr_raw.zz_eda_vist_p9_y0_HJ;
drop table hap_ddr_raw.zz_eda_vist_p10_y0_HJ;
drop table hap_ddr_raw.zz_eda_vist_p11_y0_HJ;
#################################################################################################

#################################################################################################
*Create final MSK_CBNoSurgery_21 data table
############################################################################################Total rows - 664653, No - 625579, Yes- 39074
###################################################
Create table hap_ddr_raw.zz_eda_modelling_spine_MSK_CBNoSurgery_21_HJ
AS (
SELECT z.person_internal_id
,z.partneremployerid
,z.patient_key
,z.MSK_CBNoSurgery_flag_Obj21
,ISNULL(a.HS_flag_Yr_0,'NA') as HS_flag_Yr_0
,ISNULL(a.MH_flag_Yr_0,'NA') as MH_flag_Yr_0
,ISNULL(a.MSK_CKHBSurgery_flag_Yr_0,'NA') as MSK_CKHBSurgery_flag_Yr_0
,ISNULL(a.MSK_CKHNoSurgery_flag_Yr_0,'NA') as MSK_CKHNoSurgery_flag_Yr_0
,ISNULL(a.MSK_CBNoSurgery_flag_Yr_0,'NA') as MSK_CBNoSurgery_flag_Yr_0
,ISNULL(a.tot_billed_amt_Yr_0,0) as tot_billed_amt_Yr_0
,ISNULL(a.avg_billed_amt_Yr_0,0) as avg_billed_amt_Yr_0
,ISNULL(a.std_billed_amt_Yr_0,0) as std_billed_amt_Yr_0	
,ISNULL(a.max_billed_amt_Yr_0,0) as max_billed_amt_Yr_0
,ISNULL(a.employer_paid_Yr_0,0) as employer_paid_Yr_0
,ISNULL(a.employee_paid1_Yr_0,0) as employee_paid1_Yr_0
,ISNULL(a.employee_paid2_Yr_0,0) as employee_paid2_Yr_0
,ISNULL(a.paid_thr_deduct_Yr_0,0) as paid_thr_deduct_Yr_0
,ISNULL(a.HS_flag_Yr_1,'NA') as HS_flag_Yr_1
,ISNULL(a.MH_flag_yr_1,'NA') as MH_flag_yr_1
,ISNULL(a.MSK_CKHBSurgery_flag_Yr_1,'NA') as MSK_CKHBSurgery_flag_Yr_1
,ISNULL(a.MSK_CKHNoSurgery_flag_Yr_1,'NA') as MSK_CKHNoSurgery_flag_Yr_1
,ISNULL(a.MSK_CBNoSurgery_flag_Yr_1,'NA') as MSK_CBNoSurgery_flag_Yr_1
,ISNULL(a.tot_billed_amt_yr_1,0) as tot_billed_amt_yr_1
,ISNULL(a.avg_billed_amt_yr_1,0) as avg_billed_amt_yr_1
,ISNULL(a.std_billed_amt_yr_1,0) as std_billed_amt_yr_1
,ISNULL(a.max_billed_amt_yr_1,0) as max_billed_amt_yr_1
,ISNULL(a.employer_paid_yr_1,0) as employer_paid_yr_1
,ISNULL(a.employee_paid1_yr_1,0) as employee_paid1_yr_1
,ISNULL(a.employee_paid2_yr_1,0) as employee_paid2_yr_1
,ISNULL(a.paid_thr_deduct_yr_1,0) as paid_thr_deduct_yr_1
,ISNULL(b.Preventive_flag_yr,'No') as Preventive_flag_yr
,ISNULL(b.comorbidity_flag_yr,'No') as comorbidity_flag_yr
,ISNULL(b.chronic_flag_yr,'No') as chronic_flag_yr
,ISNULL(b.Diagnosis_flag_Yr,'No') as Diagnosis_flag_Yr
,ISNULL(b.Procedure_flag_Yr,'No') as Procedure_flag_Yr	
,ISNULL(b.Preventive_flag_Yr_0,'No') as Preventive_flag_Yr_0
,ISNULL(b.comorbidity_flag_Yr_0,'No') as comorbidity_flag_Yr_0
,ISNULL(b.chronic_flag_Yr_0,'No') as chronic_flag_Yr_0
,ISNULL(b.Diagnosis_flag_Yr_0,'No') as Diagnosis_flag_Yr_0
,ISNULL(b.Procedure_flag_Yr_0,'No') as Procedure_flag_Yr_0
,ISNULL(b.Preventive_flag_yr_1,'No') as Preventive_flag_yr_1
,ISNULL(b.comorbidity_flag_yr_1,'No') as comorbidity_flag_yr_1
,ISNULL(b.chronic_flag_yr_1,'No') as chronic_flag_yr_1
,ISNULL(b.Diagnosis_flag_Yr_1,'No') as Diagnosis_flag_Yr_1
,ISNULL(b.Procedure_flag_Yr_1,'No') as Procedure_flag_Yr_1
,ISNULL(c.global_imaging_ind,'No') as global_imaging_ind
,ISNULL(c.specialist_ind,'No') as specialist_ind
,ISNULL(c.facility_imaging_ind,'No') as facility_imaging_ind
,ISNULL(c.primary_care_ind,'No') as primary_care_ind
,ISNULL(c.physician_imaging_ind,'No') as physician_imaging_ind
,ISNULL(c.inpatient_ind,'No') as inpatient_ind
,ISNULL(c.physician_ind,'No') as physician_ind
,ISNULL(c.outpatient_ind,'No') as outpatient_ind
,ISNULL(c.unknown_ind,'No') as unknown_ind
,ISNULL(c.durable_medical_ind,'No') as durable_medical_ind
,ISNULL(c.lab_visit_ind,'No') as lab_visit_ind
,ISNULL(d.global_imaging_ind,'No') as global_imaging_ind_y0
,ISNULL(d.specialist_ind,'No') as specialist_ind_y0
,ISNULL(d.facility_imaging_ind,'No') as facility_imaging_ind_y0
,ISNULL(d.primary_care_ind,'No') as primary_care_ind_y0
,ISNULL(d.physician_imaging_ind,'No') as physician_imaging_ind_y0
,ISNULL(d.inpatient_ind,'No') as inpatient_ind_y0
,ISNULL(d.physician_ind,'No') as physician_ind_y0
,ISNULL(d.outpatient_ind,'No') as outpatient_ind_y0
,ISNULL(d.unknown_ind,'No') as unknown_ind_y0
,ISNULL(d.durable_medical_ind,'No') as durable_medical_ind_y0
,ISNULL(d.lab_visit_ind,'No') as lab_visit_ind_y0
,ISNULL(e.global_imaging_ind,'No') as global_imaging_ind_y1
,ISNULL(e.specialist_ind,'No') as specialist_ind_y1
,ISNULL(e.facility_imaging_ind,'No') as facility_imaging_ind_y1
,ISNULL(e.primary_care_ind,'No') as primary_care_ind_y1
,ISNULL(e.physician_imaging_ind,'No') as physician_imaging_ind_y1
,ISNULL(e.inpatient_ind,'No') as inpatient_ind_y1
,ISNULL(e.physician_ind,'No') as physician_ind_y1
,ISNULL(e.outpatient_ind,'No') as outpatient_ind_y1
,ISNULL(e.unknown_ind,'No') as unknown_ind_y1
,ISNULL(e.durable_medical_ind,'No') as durable_medical_ind_y1
,ISNULL(e.lab_visit_ind,'No') as lab_visit_ind_y1
FROM hap_ddr_raw.zz_obj_MSK_CB_Cohort_Label_HJ z
LEFT JOIN hap_ddr_raw.zz_eda_part1_final_costYr_Yr_0Yr_1_HJ a
ON a.person_internal_id = z.person_internal_id
AND a.partneremployerid = z.partneremployerid
AND a.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_Yr_Yr_0_Yr_1_health_flags_HJ b
ON b.person_internal_id = z.person_internal_id
AND b.partneremployerid = z.partneremployerid
AND b.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_part4_proc_cat_final_HJ c 
ON c.person_internal_id = z.person_internal_id
AND c.partneremployerid = z.partneremployerid
AND c.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_part4_proc_cat_final_y0_HJ d 
ON d.person_internal_id = z.person_internal_id
AND d.partneremployerid = z.partneremployerid
AND d.patient_key = z.patient_key
LEFT JOIN hap_ddr_raw.zz_eda_part4_proc_cat_final_y1_HJ e
ON e.person_internal_id = z.person_internal_id
AND e.partneremployerid = z.partneremployerid
AND e.patient_key = z.patient_key
WHERE z.MSK_CBNoSurgery_flag_Obj21 IS NOT NULL
)

drop table hap_ddr_raw.zz_obj_MSK_CB_Cohort_Label_HJ 
drop table hap_ddr_raw.zz_eda_part1_final_costYr_Yr_0Yr_1_HJ 
drop table hap_ddr_raw.zz_eda_Yr_Yr_0_Yr_1_health_flags_HJ
drop table hap_ddr_raw.zz_eda_part4_proc_cat_final_HJ
drop table hap_ddr_raw.zz_eda_part4_proc_cat_final_y0_HJ
drop table hap_ddr_raw.zz_eda_part4_proc_cat_final_y1_HJ
############################################################################################
Pull out CSV files and upload into S3
SELECT * FROM hap_ddr_raw.zz_eda_modelling_spine_MSK_CBNoSurgery_21_HJ;


#################################################################################################
*Pull demographics file from production for people with claims in year of interest
#################################################################################################
SELECT DISTINCT c.person_internal_id
,ppt.client_id
,udp_global_id
,(2020 - CAST(SUBSTRING(birthdate,1,4) AS INT)) AS age
,ppt.gender
,ppt.marital_status
,is_union
,primary_language_code
,country_description
,ppt.state
,ppt.platform_indicator_code
,mapped_employment_status_code
,mapped_employment_status_description
,mapped_fullpart_code
,mapped_fullpart_description
,mapped_high_compensation_code
,mapped_high_compensation_description
,mapped_permanent_temporary_code
,mapped_permanent_temporary_description
,mapped_hourly_salary_code
,mapped_hourly_salary_description
,subsidiary_code
,subsidiary_description
,mapped_flex_status_code
,mapped_flex_status_description
,original_hire_date
,rehire_date
,is_rehire
,termination_date
,base_pay_regular_payrate_amount
,base_pay_regular_frequency_code
,base_pay_regular_frequency_description
,base_pay_regular_expectedaHJualsalary
,base_pay_regular_expectedaHJualsalary_range
,aHJual_benefits_base_rate
FROM edh_core_health_db.compass_claims_raw_med_claim_rollup a
JOIN edh_core_health_db.compass_claims_raw_person_identifiers c
ON  a.patient_key = c.person_key
AND a.partneremployerid= c.partneremployerid
JOIN edh_analytic_solutions_db.udp_person_idmapping idm
ON c.partneremployerid = CAST(idm.normalizedclientid AS INT)
AND c.person_internal_id = CAST(idm.platforminternalid AS INT)
JOIN edh_analytic_solutions_db.participant_integrated ppt
ON ppt.udp_global_id = idm.globalpersonidentifier
AND ppt.client_id = CAST(idm.normalizedclientid AS INT)
WHERE a.start_date_key >= 20XX0101
AND a.end_date_key <= 20XX1231

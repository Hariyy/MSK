WITH CTE AS (
SELECT 
    DISTINCT enrolid,
    CASE 
        WHEN (proc1 in ('27350', '27438', '27440', '27441', '27442', '27443', '27445', '27446', '27447', '27448', '27450', '27455', '27457', '27486', '27487')
            OR proc2  in ('27350', '27438', '27440', '27441', '27442', '27443', '27445', '27446', '27447', '27448', '27450', '27455', '27457', '27486', '27487')
            OR proc3  in ('27350', '27438', '27440', '27441', '27442', '27443', '27445', '27446', '27447', '27448', '27450', '27455', '27457', '27486', '27487')
            OR proc4  in ('27350', '27438', '27440', '27441', '27442', '27443', '27445', '27446', '27447', '27448', '27450', '27455', '27457', '27486', '27487')
            OR proc5  in ('27350', '27438', '27440', '27441', '27442', '27443', '27445', '27446', '27447', '27448', '27450', '27455', '27457', '27486', '27487')
            OR proc6  in ('27350', '27438', '27440', '27441', '27442', '27443', '27445', '27446', '27447', '27448', '27450', '27455', '27457', '27486', '27487')
            OR proc7  in ('27350', '27438', '27440', '27441', '27442', '27443', '27445', '27446', '27447', '27448', '27450', '27455', '27457', '27486', '27487')
            OR proc8  in ('27350', '27438', '27440', '27441', '27442', '27443', '27445', '27446', '27447', '27448', '27450', '27455', '27457', '27486', '27487')
            OR proc9  in ('27350', '27438', '27440', '27441', '27442', '27443', '27445', '27446', '27447', '27448', '27450', '27455', '27457', '27486', '27487')
            OR proc10 in ('27350', '27438', '27440', '27441', '27442', '27443', '27445', '27446', '27447', '27448', '27450', '27455', '27457', '27486', '27487')
            OR proc11 in ('27350', '27438', '27440', '27441', '27442', '27443', '27445', '27446', '27447', '27448', '27450', '27455', '27457', '27486', '27487')
            OR proc12 in ('27350', '27438', '27440', '27441', '27442', '27443', '27445', '27446', '27447', '27448', '27450', '27455', '27457', '27486', '27487')
            OR proc13 in ('27350', '27438', '27440', '27441', '27442', '27443', '27445', '27446', '27447', '27448', '27450', '27455', '27457', '27486', '27487')
            OR proc14 in ('27350', '27438', '27440', '27441', '27442', '27443', '27445', '27446', '27447', '27448', '27450', '27455', '27457', '27486', '27487')
            OR proc15 in ('27350', '27438', '27440', '27441', '27442', '27443', '27445', '27446', '27447', '27448', '27450', '27455', '27457', '27486', '27487'))
        THEN date_parse(admdate, '%m/%d/%Y') END as svcdate
FROM "ipadmissions"
WHERE proc1 in ('27350', '27438', '27440', '27441', '27442', '27443', '27445', '27446', '27447', '27448', '27450', '27455', '27457', '27486', '27487')
    OR proc2  in ('27350', '27438', '27440', '27441', '27442', '27443', '27445', '27446', '27447', '27448', '27450', '27455', '27457', '27486', '27487')
    OR proc3  in ('27350', '27438', '27440', '27441', '27442', '27443', '27445', '27446', '27447', '27448', '27450', '27455', '27457', '27486', '27487')
    OR proc4  in ('27350', '27438', '27440', '27441', '27442', '27443', '27445', '27446', '27447', '27448', '27450', '27455', '27457', '27486', '27487')
    OR proc5  in ('27350', '27438', '27440', '27441', '27442', '27443', '27445', '27446', '27447', '27448', '27450', '27455', '27457', '27486', '27487')
    OR proc6  in ('27350', '27438', '27440', '27441', '27442', '27443', '27445', '27446', '27447', '27448', '27450', '27455', '27457', '27486', '27487')
    OR proc7  in ('27350', '27438', '27440', '27441', '27442', '27443', '27445', '27446', '27447', '27448', '27450', '27455', '27457', '27486', '27487')
    OR proc8  in ('27350', '27438', '27440', '27441', '27442', '27443', '27445', '27446', '27447', '27448', '27450', '27455', '27457', '27486', '27487')
    OR proc9  in ('27350', '27438', '27440', '27441', '27442', '27443', '27445', '27446', '27447', '27448', '27450', '27455', '27457', '27486', '27487')
    OR proc10 in ('27350', '27438', '27440', '27441', '27442', '27443', '27445', '27446', '27447', '27448', '27450', '27455', '27457', '27486', '27487')
    OR proc11 in ('27350', '27438', '27440', '27441', '27442', '27443', '27445', '27446', '27447', '27448', '27450', '27455', '27457', '27486', '27487')
    OR proc12 in ('27350', '27438', '27440', '27441', '27442', '27443', '27445', '27446', '27447', '27448', '27450', '27455', '27457', '27486', '27487')
    OR proc13 in ('27350', '27438', '27440', '27441', '27442', '27443', '27445', '27446', '27447', '27448', '27450', '27455', '27457', '27486', '27487')
    OR proc14 in ('27350', '27438', '27440', '27441', '27442', '27443', '27445', '27446', '27447', '27448', '27450', '27455', '27457', '27486', '27487')
    OR proc15 in ('27350', '27438', '27440', '27441', '27442', '27443', '27445', '27446', '27447', '27448', '27450', '27455', '27457', '27486', '27487')
  UNION
  SELECT 
    DISTINCT TRY(CAST(enrolid as bigint)),
    CASE
        WHEN proc1 in ('27350', '27438', '27440', '27441', '27442', '27443', '27445', '27446', '27447', '27448', '27450', '27455', '27457', '27486', '27487')
        THEN date_parse(svcdate, '%m/%d/%Y') END as svcdate
    FROM "outpatient"
    WHERE proc1 in ('27350', '27438', '27440', '27441', '27442', '27443', '27445', '27446', '27447', '27448', '27450', '27455', '27457', '27486', '27487'))
, CTE2 AS (
SELECT
    enrolid,
    svcdate,
    ROW_NUMBER() OVER (PARTITION BY enrolid ORDER BY svcdate) as enrol_count
FROM CTE
ORDER BY enrolid, svcdate)
, CTE3 AS (
SELECT 
    *
FROM CTE2 c
JOIN "prescriptiondrugs" o
    ON c.enrolid = TRY(CAST(o.enrolid as bigint))
    AND date_parse(o.svcdate, '%m/%d/%Y') < c.svcdate
WHERE enrol_count = 1)
SELECT
    ndcnum
FROM CTE3